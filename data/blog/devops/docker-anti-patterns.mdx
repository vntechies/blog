---
title: 'Docker Anti Patterns'
date: '2022-11-01'
tags: ['devops', 'container', 'docker']
draft: false
images: ['/static/images/ogps/docker_anti_patterns.jpeg']
summary: 'Trong bÃ i viáº¿t nÃ y, chÃºng ta sáº½ trÃ¬nh bÃ y má»™t sá»‘ phÆ°Æ¡ng phÃ¡p khÃ´ng tá»‘t, cÃ¡c anti-pattern khi sá»­ dá»¥ng container vÃ  giáº£i phÃ¡p cáº£i thiá»‡n cho tá»«ng phÆ°Æ¡ng phÃ¡p.'
---

![Docker Anti Pattern](/static/images/ogps/docker_anti_patterns.jpeg)

Container Ä‘ang bÃ¹ng ná»• vÃ  trá»Ÿ thÃ nh má»™t cÃ´ng nghá»‡ Ä‘Æ°á»£c sá»­ dá»¥ng rá»™ng rÃ£i trong nhá»¯ng nÄƒm gáº§n Ä‘Ã¢y. Ngay cáº£ khi báº¡n chÆ°a tin ráº±ng Kubernetes sáº½ lÃ  cÃ´ng nghá»‡ tá»‘t trong tÆ°Æ¡ng lai, thÃ¬ viá»‡c sá»­ dá»¥ng Docker thÃ´i cÅ©ng mang láº¡i nhiá»u giÃ¡ trá»‹. Container cÃ³ thá»ƒ Ä‘Æ¡n giáº£n hÃ³a cáº£ viá»‡c triá»ƒn khai vÃ  cÃ¡c CI/CD pipelines.

Trang web chÃ­nh thá»©c cá»§a Docker trÃ¬nh bÃ y vá» cÃ¡c phÆ°Æ¡ng phÃ¡p tá»‘t nháº¥t cá»§a Docker vÃ  thÆ°á»ng nÃ³ sáº½ cÃ³ tÃ­nh ká»¹ thuáº­t cao, táº­p trung nhiá»u hÆ¡n vÃ o cáº¥u trÃºc cá»§a Dockerfile thay vÃ¬ thÃ´ng tin chung vá» cÃ¡ch sá»­ dá»¥ng container. Má»™t ngÆ°á»i má»›i sá»­ dá»¥ng Docker Ä‘áº¿n má»™t lÃºc nÃ o Ä‘Ã³ sáº½ hiá»ƒu vá» cÃ¡c layer cá»§a Docker, cÃ¡ch chÃºng Ä‘Æ°á»£c lÆ°u vÃ o bá»™ nhá»› cache vÃ  cÃ¡ch táº¡o Docker image nhá». Viá»‡c sá»­ dá»¥ng multi-stage builds cÅ©ng khÃ´ng quÃ¡ khÃ³.

Tuy nhiÃªn, váº¥n Ä‘á» chÃ­nh cá»§a viá»‡c sá»­ dá»¥ng container lÃ  cÃ¡c cÃ´ng ty khÃ´ng cÃ³ kháº£ nÄƒng nhÃ¬n vÃ o bá»©c tranh lá»›n hÆ¡n vÃ  Ä‘áº·c biá»‡t lÃ  tÃ­nh cháº¥t báº¥t biáº¿n cá»§a container/image. Má»™t sá»‘ cÃ´ng ty Ä‘áº·c biá»‡t cá»‘ gáº¯ng chuyá»ƒn Ä‘á»•i cÃ¡c quy trÃ¬nh dá»±a trÃªn VM hiá»‡n cÃ³ cá»§a há» thÃ nh cÃ¡c thÃ¹ng chá»©a vá»›i káº¿t quáº£ khÃ´ng rÃµ rÃ ng. CÃ³ ráº¥t nhiá»u thÃ´ng tin vá» cÃ¡c chi tiáº¿t low-level cá»§a container (cÃ¡ch táº¡o vÃ  cháº¡y chÃºng), nhÆ°ng ráº¥t Ã­t thÃ´ng tin vá» cÃ¡c phÆ°Æ¡ng phÃ¡p tá»‘t nháº¥t á»Ÿ high-level.

Äá»ƒ thu háº¹p khoáº£ng cÃ¡ch cá»§a cÃ¡c tÃ i liá»‡u nÃ y, tÃ´i sáº½ trÃ¬nh bÃ y danh sÃ¡ch cÃ¡c phÆ°Æ¡ng phÃ¡p tá»‘t nháº¥t cá»§a Docker á»Ÿ high-level. Hy vá»ng ráº±ng, bÃ i viáº¿t sáº½ cung cáº¥p cho báº¡n má»™t sá»‘ hiá»ƒu biáº¿t vá» cÃ¡ch báº¡n nÃªn sá»­ dá»¥ng container.

DÆ°á»›i Ä‘Ã¢y lÃ  danh sÃ¡ch Ä‘áº§y Ä‘á»§ cÃ¡c phÆ°Æ¡ng phÃ¡p khÃ´ng tá»‘t mÃ  chÃºng ta sáº½ kiá»ƒm tra:

<TOCInline toc={props.toc} asDisclosure />

## Anti-pattern 1 - Coi Docker container nhÆ° mÃ¡y áº£o (VM)

TrÆ°á»›c khi Ä‘i vÃ o má»™t sá»‘ vÃ­ dá»¥ thá»±c táº¿ hÆ¡n, chÃºng ta hÃ£y tÃ¬m hiá»ƒu lÃ½ thuyáº¿t cÆ¡ báº£n trÆ°á»›c. **CÃ¡c container khÃ´ng pháº£i lÃ  mÃ¡y áº£o**. Thoáº¡t nhÃ¬n, chÃºng cÃ³ thá»ƒ trÃ´ng nhÆ° chÃºng hoáº¡t Ä‘á»™ng giá»‘ng VM nhÆ°ng sá»± tháº­t láº¡i hoÃ n toÃ n khÃ¡c vá»›i nhá»¯ng cÃ¢u há»i nhÆ°:

1. [LÃ m cÃ¡ch nÃ o Ä‘á»ƒ cáº­p nháº­t cÃ¡c á»©ng dá»¥ng Ä‘ang cháº¡y bÃªn trong container?](https://unix.stackexchange.com/questions/123482/application-updates-inside-of-docker-containers)
2. [LÃ m cÃ¡ch nÃ o Ä‘á»ƒ ssh vÃ o Docker container?](https://stackoverflow.com/questions/28134239/how-to-ssh-into-docker)
3. [LÃ m cÃ¡ch nÃ o Ä‘á»ƒ láº¥y nháº­t kÃ½/tá»‡p tá»« container?](https://stackoverflow.com/questions/44744188/docker-how-to-see-the-logs-of-running-application-inside-docker-container)
4. [LÃ m cÃ¡ch nÃ o Ä‘á»ƒ Ã¡p dá»¥ng cÃ¡c báº£n sá»­a lá»—i báº£o máº­t bÃªn trong container?](https://serverfault.com/questions/611082/how-to-handle-security-updates-within-docker-containers)
5. [LÃ m cÃ¡ch nÃ o Ä‘á»ƒ cháº¡y nhiá»u chÆ°Æ¡ng trÃ¬nh trong má»™t container?](https://stackoverflow.com/questions/19948149/can-i-run-multiple-programs-in-a-docker-container)

Táº¥t cáº£ nhá»¯ng cÃ¢u há»i nÃ y Ä‘á»u Ä‘Ãºng vá» máº·t ká»¹ thuáº­t, vÃ  nhá»¯ng ngÆ°á»i Ä‘Ã£ tráº£ lá»i chÃºng cÅ©ng Ä‘Ã£ Ä‘Æ°a ra nhá»¯ng cÃ¢u tráº£ lá»i chÃ­nh xÃ¡c vá» máº·t ká»¹ thuáº­t.

> LÃ m cÃ¡ch nÃ o Ä‘á»ƒ tÃ´i cÃ³ thá»ƒ bá» táº¥t cáº£ cÃ¡c phÆ°Æ¡ng phÃ¡p, quy trÃ¬nh Ã¡p dá»¥ng vá»›i VM Ä‘á»ƒ thay Ä‘á»•i quy trÃ¬nh lÃ m viá»‡c vá»›i cÃ¡c container khÃ´ng tráº¡ng thÃ¡i, báº¥t biáº¿n, tá»“n táº¡i trong thá»i gian ngáº¯n (stateless, immutable, short-lived) thay vÃ¬ cÃ¡c mÃ¡y áº£o cÃ³ tráº¡ng thÃ¡i, hoáº¡t Ä‘á»™ng lÃ¢u dÃ i, cÃ³ thá»ƒ thay Ä‘á»•i (stateful, long-running, mutable)?

Nhiá»u cÃ´ng ty ngoÃ i kia Ä‘ang cá»‘ gáº¯ng sá»­ dá»¥ng láº¡i cÃ¡c phÆ°Æ¡ng phÃ¡p/cÃ´ng cá»¥/kiáº¿n thá»©c tÆ°Æ¡ng tá»± tá»« mÃ¡y áº£o cho container. Má»™t sá»‘ cÃ´ng ty tháº­m chÃ­ chÆ°a hoÃ n thÃ nh viá»‡c chuyá»ƒn Ä‘á»•i tá»« bare-metal sang VM khi cÃ¡c container xuáº¥t hiá»‡n.

Viá»‡c há»c láº¡i Ä‘iá»u gÃ¬ Ä‘Ã³ lÃ  ráº¥t khÃ³. Háº§u háº¿t nhá»¯ng ngÆ°á»i báº¯t Ä‘áº§u sá»­ dá»¥ng container Ä‘á»u xem chÃºng ban Ä‘áº§u nhÆ° má»™t lá»›p trá»«u tÆ°á»£ng bá»• sung bÃªn trÃªn cÃ¡c phÆ°Æ¡ng phÃ¡p hiá»‡n cÃ³ cá»§a há»:

![Containers khÃ´ng pháº£i VMs](/static/images/assets/docker_anti_patterns_vmnotcontainer.png)

<p align="center">
  <small>Containers khÃ´ng pháº£i VMs (Nguá»“n: [codefresh.io](https://codefresh.io/))</small>
</p>

Trong thá»±c táº¿, containers yÃªu cáº§u má»™t cÃ¡i nhÃ¬n hoÃ n toÃ n khÃ¡c vÃ  thay Ä‘á»•i cÃ¡c quy trÃ¬nh hiá»‡n cÃ³.

![Container yÃªu cáº§u má»™t cÃ¡ch suy nghÄ© má»›i](/static/images/assets/docker_anti_patterns_container.png)

<p align="center">
  <small>
    Container yÃªu cáº§u má»™t cÃ¡ch suy nghÄ© má»›i (Nguá»“n: [codefresh.io](https://codefresh.io/))
  </small>
</p>

KhÃ´ng cÃ³ cÃ¡ch kháº¯c phá»¥c nÃ o dá»… dÃ ng cho anti-pattern nÃ y ngoÃ i viá»‡c há»c vÃ  hiá»ƒu vá» báº£n cháº¥t cá»§a cÃ¡c containers, cÃ¡c khá»‘i xÃ¢y dá»±ng vÃ  lá»‹ch sá»­ cá»§a chÃºng.

Náº¿u báº¡n thÆ°á»ng xuyÃªn tháº¥y mÃ¬nh muá»‘n ssh Ä‘áº¿n cÃ¡c container Ä‘ang cháº¡y Ä‘á»ƒ "nÃ¢ng cáº¥p" chÃºng hoáº·c láº¥y nháº­t kÃ½/tá»‡p theo cÃ¡ch thá»§ cÃ´ng, báº¡n cháº¯c cháº¯n Ä‘ang sá»­ dá»¥ng Docker sai cÃ¡ch vÃ  báº¡n cáº§n Ä‘á»c thÃªm vá» cÃ¡ch cÃ¡c container hoáº¡t Ä‘á»™ng.

## Anti-pattern 2 - Táº¡o Docker image khÃ´ng trong suá»‘t

**Má»™t Dockerfile pháº£i minh báº¡ch vÃ  Ä‘á»™c láº­p. NÃ³ pháº£i mÃ´ táº£ rÃµ rÃ ng táº¥t cáº£ cÃ¡c thÃ nh pháº§n cá»§a má»™t á»©ng dá»¥ng. Báº¥t ká»³ ai cÅ©ng cÃ³ thá»ƒ nháº­n Ä‘Æ°á»£c cÃ¹ng má»™t Dockerfile vÃ  táº¡o láº¡i cÃ¹ng má»™t image. CÃ¡c bÆ°á»›c "magic" nÃªn Ä‘Æ°á»£c trÃ¡nh.**

DÆ°á»›i Ä‘Ã¢y lÃ  má»™t vÃ­ dá»¥ khÃ´ng tá»‘t:

```yaml
FROM alpine:3.4

RUN apk add --no-cache \
      ca-certificates \
      pciutils \
      ruby \
      ruby-irb \
      ruby-rdoc \
      && \
    echo http://dl-4.alpinelinux.org/alpine/edge/community/ >> /etc/apk/repositories && \
    apk add --no-cache shadow && \
    gem install puppet:"5.5.1" facter:"2.5.1" && \
    /usr/bin/puppet module install puppetlabs-apk

# Install Java application
RUN /usr/bin/puppet agent --onetime --no-daemonize

ENTRYPOINT ["java","-jar","/app/spring-boot-application.jar"]
```

Äá»«ng hiá»ƒu láº§m, tÃ´i thÃ­ch Puppet vÃ¬ nÃ³ lÃ  má»™t cÃ´ng cá»¥ tuyá»‡t vá»i (hoáº·c Ansible hoáº·c Chef cho váº¥n Ä‘á» Ä‘Ã³). Viá»‡c láº¡m dá»¥ng nÃ³ Ä‘á»ƒ triá»ƒn khai á»©ng dá»¥ng cÃ³ thá»ƒ dá»… dÃ ng vá»›i mÃ¡y áº£o, nhÆ°ng vá»›i container thÃ¬ Ä‘iá»u Ä‘Ã³ tháº­t tá»‡ háº¡i.

TrÆ°á»›c háº¿t, nÃ³ lÃ m cho Dockerfile nÃ y phá»¥ thuá»™c vÃ o vá»‹ trÃ­ cá»§a host. Báº¡n pháº£i xÃ¢y dá»±ng nÃ³ trÃªn má»™t mÃ¡y tÃ­nh cÃ³ quyá»n truy cáº­p vÃ o mÃ¡y chá»§ Puppet trÃªn mÃ´i trÆ°á»ng production. MÃ¡y tráº¡m cá»§a báº¡n cÃ³ quyá»n truy cáº­p vÃ o mÃ¡y Puppet trÃªn mÃ´i trÆ°á»ng production khÃ´ng? Náº¿u cÃ³, mÃ¡y tráº¡m cá»§a báº¡n cÃ³ thá»±c sá»± nÃªn quyá»n truy cáº­p vÃ o mÃ¡y chá»§ Puppet trÃªn mÃ´i trÆ°á»ng production khÃ´ng?

NhÆ°ng váº¥n Ä‘á» lá»›n nháº¥t lÃ  Docker image nÃ y khÃ´ng thá»ƒ Ä‘Æ°á»£c táº¡o láº¡i dá»… dÃ ng. Ná»™i dung cá»§a nÃ³ phá»¥ thuá»™c vÃ o nhá»¯ng gÃ¬ mÃ¡y chá»§ Puppet cÃ³ táº¡i thá»i Ä‘iá»ƒm build ban Ä‘áº§u. Náº¿u báº¡n xÃ¢y dá»±ng cÃ¹ng má»™t Dockerfile vÃ o má»™t ngÃ y khÃ¡c, báº¡n cÃ³ thá»ƒ nháº­n Ä‘Æ°á»£c má»™t image hoÃ n toÃ n khÃ¡c. VÃ  náº¿u báº¡n khÃ´ng cÃ³ quyá»n truy cáº­p Ä‘áº¿n mÃ¡y chá»§ Puppet hoáº·c mÃ¡y Puppet khÃ´ng hoáº¡t Ä‘á»™ng, báº¡n tháº­m chÃ­ khÃ´ng thá»ƒ build image ngay tá»« Ä‘áº§u. Báº¡n tháº­m chÃ­ khÃ´ng biáº¿t phiÃªn báº£n cá»§a á»©ng dá»¥ng lÃ  gÃ¬ náº¿u báº¡n khÃ´ng cÃ³ quyá»n truy cáº­p vÃ o cÃ¡c puppet script.

NhÃ³m táº¡o Dockerfile nÃ y Ä‘Ã£ hÆ¡i lÆ°á»i biáº¿ng. ÄÃ£ cÃ³ má»™t puppet script Ä‘á»ƒ cÃ i Ä‘áº·t á»©ng dá»¥ng trong mÃ¡y áº£o. Dockerfile chá»‰ Ä‘á»ƒ lÃ m Ä‘iá»u tÆ°Æ¡ng tá»± (xem anti-pattern trÆ°á»›c).

CÃ¡ch kháº¯c phá»¥c á»Ÿ Ä‘Ã¢y lÃ  cÃ³ cÃ¡c Dockerfiles tá»‘i giáº£n mÃ´ táº£ rÃµ rÃ ng nhá»¯ng gÃ¬ chÃºng lÃ m. ÄÃ¢y lÃ  vÃ­ dá»¥ tÆ°Æ¡ng tá»± tá»± vá»›i má»™t Dockerfile "nghiÃªm chá»‰nh".

```yaml
FROM openjdk:8-jdk-alpine

ENV MY_APP_VERSION="3.2"

RUN apk add --no-cache \
ca-certificates

WORKDIR /app
ADD  http://artifactory.mycompany.com/releases/${MY_APP_VERSION}/spring-boot-application.jar .

ENTRYPOINT ["java","-jar","/app/spring-boot-application.jar"]
```

ChÃº Ã½ ráº±ng:

- KhÃ´ng cÃ³ sá»± phá»¥ thuá»™c vÃ o cÆ¡ sá»Ÿ háº¡ táº§ng puppet. Dockerfile cÃ³ thá»ƒ Ä‘Æ°á»£c xÃ¢y dá»±ng trÃªn báº¥t ká»³ mÃ¡y tÃ­nh nÃ o cÃ³ quyá»n truy cáº­p vÃ o kho lÆ°u trá»¯ nhá»‹ phÃ¢n.
- CÃ¡c phiÃªn báº£n cá»§a pháº§n má»m Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh rÃµ rÃ ng.
- Ráº¥t dá»… dÃ ng Ä‘á»ƒ thay Ä‘á»•i phiÃªn báº£n cá»§a á»©ng dá»¥ng báº±ng cÃ¡ch chá»‰ chá»‰nh sá»­a Dockerfile (thay vÃ¬ cÃ¡c puppet script).
- ÄÃ¢y chá»‰ lÃ  má»™t vÃ­ dá»¥ ráº¥t Ä‘Æ¡n giáº£n. TÃ´i Ä‘Ã£ tháº¥y nhiá»u Dockerfiles phá»¥ thuá»™c vÃ o cÃ¡c cÃ´ng thá»©c "magic" vá»›i cÃ¡c yÃªu cáº§u Ä‘áº·c biá»‡t vá» thá»i gian vÃ  Ä‘á»‹a Ä‘iá»ƒm chÃºng cÃ³ thá»ƒ Ä‘Æ°á»£c táº¡o ra. Vui lÃ²ng khÃ´ng viáº¿t Dockerfiles cá»§a báº¡n theo cÃ¡ch nÃ y, vÃ¬ cÃ¡c nhÃ  phÃ¡t triá»ƒn (vÃ  nhá»¯ng ngÆ°á»i khÃ¡c khÃ´ng cÃ³ quyá»n truy cáº­p vÃ o táº¥t cáº£ cÃ¡c há»‡ thá»‘ng) sáº½ gáº·p khÃ³ khÄƒn lá»›n trong viá»‡c táº¡o Docker image trong mÃ´i trÆ°á»ng local cá»§a há».

Má»™t giáº£i phÃ¡p thay tháº¿ tá»‘t hÆ¡n sáº½ lÃ  náº¿u Dockerfile tá»± biÃªn dá»‹ch mÃ£ nguá»“n Java (sá»­ dá»¥ng multi-stage builds). Äiá»u Ä‘Ã³ sáº½ cung cáº¥p cho báº¡n kháº£ nÄƒng thá»ƒ hiá»‡n rÃµ hÆ¡n vá» nhá»¯ng gÃ¬ Ä‘ang xáº£y ra trong Docker image.

## Anti-pattern 3 - Táº¡o cÃ¡c Dockerfiles cÃ³ áº£nh hÆ°á»Ÿng tá»›i bÃªn ngoÃ i

HÃ£y tÆ°á»Ÿng tÆ°á»£ng ráº±ng báº¡n lÃ  ká»¹ sÆ° váº­n hÃ nh/SRE Ä‘ang lÃ m viá»‡c táº¡i má»™t cÃ´ng ty ráº¥t lá»›n, nÆ¡i sá»­ dá»¥ng nhiá»u ngÃ´n ngá»¯ láº­p trÃ¬nh.Sáº½ ráº¥t khÃ³ Ä‘á»ƒ trá»Ÿ thÃ nh má»™t chuyÃªn gia vá» táº¥t cáº£ cÃ¡c ngÃ´n ngá»¯ láº­p trÃ¬nh vÃ  cÃ¡c há»‡ thá»‘ng build sá»­ dá»¥ng á»Ÿ Ä‘Ã³.

ÄÃ¢y lÃ  má»™t trong nhá»¯ng lá»£i tháº¿ cá»§a viá»‡c Ã¡p dá»¥ng container. Báº¡n cÃ³ thá»ƒ táº£i xuá»‘ng báº¥t ká»³ tá»‡p Dockerfile nÃ o tá»« báº¥t ká»³ nhÃ³m phÃ¡t triá»ƒn nÃ o vÃ  build tá»‡p Ä‘Ã³ mÃ  khÃ´ng cáº§n quan tÃ¢m Ä‘áº¿n cÃ¡c áº£nh hÆ°á»Ÿng bÃªn ngoÃ i nÃ³ cÃ³ thá»ƒ táº¡o ra (vÃ¬ khÃ´ng nÃªn cÃ³ báº¥t ká»³ áº£nh hÆ°á»Ÿng nÃ o).

Viá»‡c build Docker image pháº£i lÃ  má»™t hoáº¡t Ä‘á»™ng lÃ½ tÆ°á»Ÿng, khÃ´ng quan trá»ng viá»‡c báº¡n build cÃ¹ng má»™t Dockerfile má»™t láº§n hay má»™t nghÃ¬n láº§n, hoáº·c náº¿u báº¡n xÃ¢y dá»±ng nÃ³ trÃªn mÃ¡y chá»§ CI trÆ°á»›c vÃ  sau Ä‘Ã³ trÃªn mÃ¡y tráº¡m cá»§a báº¡n.

Tuy nhiÃªn, cÃ³ má»™t sá»‘ Dockerfiles ngoÃ i Ä‘Ã³ trong giai Ä‘oáº¡n build sáº½:

1. Thá»±c hiá»‡n cÃ¡c git commit hoáº·c cÃ¡c thao tÃ¡c khÃ¡c vá»›i git
2. Dá»n dáº¹p hoáº·c xÃ¡o trá»™n cÆ¡ sá»Ÿ dá»¯ liá»‡u
3. Gá»i cÃ¡c dá»‹ch vá»¥ bÃªn ngoÃ i vá»›i cÃ¡c thao tÃ¡c POST/PUT (thay Ä‘á»•i dá»¯ liá»‡u)

Container cung cáº¥p kháº£ nÄƒng cÃ¡ch ly (isolation) vá»›i Ä‘áº¿n há»‡ thá»‘ng tá»‡p cá»§a host nhÆ°ng khÃ´ng cÃ³ gÃ¬ Ä‘áº£m báº£o ráº±ng Dockerfile sáº½ khÃ´ng cÃ³ chá»‰ thá»‹ RUN gá»­i má»™t HTTP request cÃ¹ng payload Ä‘áº¿n máº¡ng ná»™i bá»™ cá»§a báº¡n.

ÄÃ¢y lÃ  má»™t vÃ­ dá»¥ Ä‘Æ¡n giáº£n trong Ä‘Ã³ má»™t Dockerfile thá»±c hiá»‡n viá»‡c Ä‘Ã³ng gÃ³i (hÃ nh Ä‘á»™ng an toÃ n) vÃ  cÃ´ng khai (hÃ nh Ä‘á»™ng khÃ´ng an toÃ n) má»™t á»©ng dá»¥ng npm trong má»™t láº§n cháº¡y.

```yaml
FROM node:9
WORKDIR /app

COPY package.json ./package.json
COPY package-lock.json ./package-lock.json
RUN npm install
COPY . .

RUN npm test

ARG npm_token

RUN echo "//registry.npmjs.org/:_authToken=${npm_token}" > .npmrc
RUN npm publish --access public

EXPOSE 8080
CMD [ "npm", "start" ]
```

Dockerfile nÃ y gÃ¢y nháº§m láº«n giá»¯a hai má»‘i quan tÃ¢m khÃ¡c nhau, phÃ¡t hÃ nh má»™t phiÃªn báº£n cá»§a á»©ng dá»¥ng vÃ  táº¡o Docker image cho nÃ³. CÃ³ thá»ƒ Ä‘Ã´i khi hai hÃ nh Ä‘á»™ng nÃ y thá»±c sá»± xáº£y ra cÃ¹ng má»™t lÃºc, nhÆ°ng Ä‘Ã¢y khÃ´ng pháº£i lÃ  lÃ½ do Ä‘á»ƒ lÃ m má»™t Dockerfile trá»Ÿ nÃªn khÃ´ng gá»n gÃ ng vá»›i cÃ¡c áº£nh hÆ°á»Ÿng phá»¥.

Docker **KHÃ”NG** pháº£i lÃ  má»™t há»‡ thá»‘ng CI nÃ³i chung vÃ  nÃ³ chÆ°a bao giá» giá»‘ng nhÆ° váº­y. Äá»«ng láº¡m dá»¥ng Dockerfile nhÆ° nhá»¯ng táº­p lá»‡nh bash. DÃ¹ viá»‡c cÃ³ nhá»¯ng áº£nh hÆ°á»Ÿng phá»¥ trong container run time lÃ  Ä‘iá»u cháº¥p nháº­n Ä‘Æ°á»£c nhÆ°ng nhá»¯ng áº£nh hÆ°á»Ÿng Ä‘Ã³ Ä‘Æ°á»£c táº¡o ra khi trong container build time thÃ¬ khÃ´ng.

Giáº£i phÃ¡p lÃ  Ä‘Æ¡n giáº£n hÃ³a cÃ¡c tá»‡p Dockerfile cá»§a báº¡n vÃ  Ä‘áº£m báº£o ráº±ng chÃºng chá»‰ chá»©a cÃ¡c logic Ä‘Æ¡n giáº£n nhÆ°:

- Clone mÃ£ nguá»“n
- Download cÃ¡c dependency
- BiÃªn dá»‹ch vÃ  Ä‘Ã³ng gÃ³i mÃ£ Nguá»“n
- Xá»­ lÃ½/Thu gá»n/Biáº¿n Ä‘á»•i cÃ¡c tÃ i nguyÃªn cá»¥c bá»™ (bÃªn trong container)
- Cháº¡y cÃ¡c scripts vÃ  sá»­a cÃ¡c tá»‡p trÃªn há»‡ thá»‘ng file cá»§a container

NgoÃ i ra, hÃ£y nhá»› ráº±ng cÃ¡ch Docker cache cÃ¡c layer cá»§a filesystem. Docker giáº£ Ä‘á»‹nh ráº±ng náº¿u má»™t layer vÃ  cÃ¡c layer trÆ°á»›c Ä‘Ã³ chÆ°a "thay Ä‘á»•i" thÃ¬ chÃºng cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng láº¡i tá»« bá»™ nhá»› cache. Náº¿u cÃ¡c lá»‡nh Dockerfile cá»§a báº¡n cÃ³ cÃ¡c áº£nh hÆ°á»Ÿng phá»¥, vá» cÆ¡ báº£n, báº¡n Ä‘Ã£ phÃ¡ vá»¡ cÆ¡ cháº¿ cache cá»§a Docker.

```yaml
FROM node:10.15-jessie

RUN apt-get update && apt-get install -y mysql-client && rm -rf /var/lib/apt

RUN mysql -u root --password="" < test/prepare-db-for-tests.sql

WORKDIR /app

COPY package.json ./package.json
COPY package-lock.json ./package-lock.json
RUN npm install
COPY . .

RUN npm integration-test

EXPOSE 8080
CMD [ "npm", "start" ]
```

Giáº£ sá»­ ráº±ng báº¡n cá»‘ gáº¯ng xÃ¢y dá»±ng tá»‡p Dockerfile nÃ y vÃ  cÃ¡c unit-test cá»§a báº¡n khÃ´ng thÃ nh cÃ´ng. Báº¡n thá»±c hiá»‡n thay Ä‘á»•i Ä‘á»‘i vá»›i mÃ£ nguá»“n vÃ  build láº¡i. Docker sáº½ giáº£ Ä‘á»‹nh ráº±ng layer xoÃ¡ DB Ä‘Ã£ "cháº¡y" vÃ  nÃ³ sáº½ sá»­ dá»¥ng láº¡i bá»™ nhá»› cache. VÃ¬ váº­y, cÃ¡c unit-test cá»§a báº¡n bÃ¢y giá» sáº½ cháº¡y trong má»™t DB chÆ°a Ä‘Æ°á»£c xoÃ¡ vÃ  chá»©a dá»¯ liá»‡u tá»« láº§n cháº¡y trÆ°á»›c.

Trong vÃ­ dá»¥ nÃ y, Dockerfile ráº¥t nhá» vÃ  sáº½ dá»… dÃ ng xÃ¡c Ä‘á»‹nh vá»‹ trÃ­ cÃ¢u lá»‡nh cÃ³ áº£nh hÆ°á»Ÿng phá»¥ (lá»‡nh mysql) vÃ  di chuyá»ƒn nÃ³ Ä‘áº¿n Ä‘Ãºng vá»‹ trÃ­ Ä‘á»ƒ sá»­a bá»™ nhá»› cache cá»§a layer, cá»‘ gáº¯ng tÃ¬m Ä‘Ãºng thá»© tá»± cá»§a cÃ¢u lá»‡nh RUN ráº¥t khÃ³ náº¿u báº¡n khÃ´ng biáº¿t cÃ¢u nÃ o cÃ³ áº£nh hÆ°á»Ÿng phá»¥ vÃ  cÃ¢u nÃ o khÃ´ng.

Dockerfiles cá»§a báº¡n sáº½ Ä‘Æ¡n giáº£n hÆ¡n nhiá»u náº¿u táº¥t cáº£ cÃ¡c hÃ nh Ä‘á»™ng mÃ  chÃºng thá»±c hiá»‡n á»Ÿ cháº¿ Ä‘á»™ chá»‰ Ä‘á»c vÃ  vá»›i pháº¡m vi cá»¥c bá»™.

## Anti-pattern 4 - Nháº§m láº«n giá»¯a image Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ phÃ¡t triá»ƒn vá»›i nhá»¯ng image Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ triá»ƒn khai

Trong báº¥t ká»³ cÃ´ng ty nÃ o Ä‘Ã£ sá»­ dá»¥ng container, thÆ°á»ng cÃ³ hai danh má»¥c Docker image riÃªng biá»‡t. Äáº§u tiÃªn, cÃ³ nhá»¯ng image Ä‘Æ°á»£c sá»­ dá»¥ng lÃ m artifact Ä‘á»ƒ triá»ƒn khai trÃªn cÃ¡c mÃ¡y chá»§ sáº£n xuáº¥t.

CÃ¡c image dÃ¹ng Ä‘á»ƒ triá»ƒn khai pháº£i chá»©a:

1. MÃ£ á»©ng dá»¥ng á»Ÿ dáº¡ng Ä‘Ã£ Ä‘Æ°á»£c rÃºt gá»n/biÃªn dá»‹ch kÃ¨m vá»›i cÃ¡c phá»¥ thuá»™c cho run time cá»§a nÃ³.
2. KhÃ´ng cÃ³ gÃ¬ khÃ¡c, thá»±c sá»± khÃ´ng cÃ³ thÃªm báº¥t cá»© thá»© gÃ¬ khÃ¡c.

Loáº¡i thá»© hai lÃ  cÃ¡c image Ä‘Æ°á»£c sá»­ dá»¥ng cho cÃ¡c há»‡ thá»‘ng CI/CD hoáº·c dÃ nh cho cÃ¡c ká»¹ sÆ° phÃ¡t triá»ƒn, cáº§n cÃ³:

1. MÃ£ nguá»“n á»Ÿ dáº¡ng ban Ä‘áº§u (VD: chÆ°a Ä‘Æ°á»£c thu gá»n)
2. TrÃ¬nh biÃªn dá»‹ch/bá»™ thu nhá»/bá»™ chuyá»ƒn Ä‘á»•i (Compilers/minifiers/transpilers)
3. Framework kiá»ƒm thá»­/cÃ¡c cÃ´ng cá»¥ bÃ¡o cÃ¡o
4. QuÃ©t báº£o máº­t, quÃ©t cháº¥t lÆ°á»£ng, mÃ¡y phÃ¢n tÃ­ch tÄ©nh (Security scanning, quality scanning, static analyzers)
5. CÃ¡c cÃ´ng cá»¥ tÃ­ch há»£p vá»›i cloud
6. CÃ¡c tiá»‡n Ã­ch khÃ¡c cáº§n thiáº¿t cho CI/CD pipeline

RÃµ rÃ ng lÃ  cÃ¡c danh má»¥c container image nÃ y nÃªn Ä‘Æ°á»£c tÃ¡ch biá»‡t vÃ¬ chÃºng cÃ³ cÃ¡c má»¥c Ä‘Ã­ch khÃ¡c nhau. Image Ä‘Æ°á»£c triá»ƒn khai tá»›i mÃ¡y chá»§ sáº£n xuáº¥t pháº£i á»Ÿ má»©c tá»‘i giáº£n, an toÃ n vÃ  cháº¯c cháº¯n. Image Ä‘Æ°á»£c sá»­ dá»¥ng trong quy trÃ¬nh CI/CD thÃ¬ khÃ´ng bao giá» nÃªn Ä‘Æ°á»£c triá»ƒn khai á»Ÿ báº¥t cá»© Ä‘Ã¢u nÃªn chÃºng cÃ³ yÃªu cáº§u Ã­t nghiÃªm ngáº·t hÆ¡n nhiá»u (vá» kÃ­ch thÆ°á»›c vÃ  báº£o máº­t).

Tuy nhiÃªn, vÃ¬ má»™t sá»‘ lÃ½ do, má»i ngÆ°á»i khÃ´ng pháº£i lÃºc nÃ o cÅ©ng hiá»ƒu sá»± khÃ¡c biá»‡t nÃ y. TÃ´i Ä‘Ã£ tháº¥y má»™t sá»‘ cÃ´ng ty cá»‘ gáº¯ng sá»­ dá»¥ng cÃ¹ng má»™t image Docker cho cáº£ quy trÃ¬nh phÃ¡t triá»ƒn vÃ  triá»ƒn khai. Háº§u nhÆ° cÃ¡c tiá»‡n Ã­ch vÃ  framework khÃ´ng liÃªn quan cuá»‘i cÃ¹ng láº¡i xuáº¥t hiá»‡n trong Docker image cá»§a mÃ´i trÆ°á»ng sáº£n xuáº¥t.

CÃ³ chÃ­nh xÃ¡c **0 lÃ½ do** cho viá»‡c Docker image á»Ÿ mÃ´i trÆ°á»ng sáº£n xuáº¥t cáº§n cÃ³ git, framework kiá»ƒm thá»­ hoáº·c trÃ¬nh biÃªn dá»‹ch/trÃ¬nh thu nhá».

Viá»‡c sá»­ dá»¥ng má»™t artifact chung Ä‘á»ƒ triá»ƒn khai luÃ´n lÃ  giá»¯a cÃ¡c mÃ´i trÆ°á»ng Ä‘á»ƒ Ä‘áº£m báº£o ráº±ng nhá»¯ng gÃ¬ báº¡n Ä‘ang kiá»ƒm thá»­ cÅ©ng lÃ  nhá»¯ng gÃ¬ báº¡n sáº½ triá»ƒn khai (sáº½ Ä‘Æ°á»£c nÃ³i rÃµ hÆ¡n á»Ÿ pháº§n sau) lÃ  má»™t Ä‘iá»u nÃªn lÃ m. NhÆ°ng cá»‘ gáº¯ng cá»‘ gáº¯ng sá»­ dá»¥ng nhá»¯ng gÃ¬ á»Ÿ mÃ´i trÆ°á»ng local trong quÃ¡ trÃ¬nh phÃ¡t triá»ƒn cho mÃ´i trÆ°á»ng sáº£n xuáº¥t thÃ¬ khÃ´ng tá»‘t má»™t chÃºt nÃ o.

TÃ³m láº¡i, hÃ£y cá»‘ gáº¯ng hiá»ƒu vai trÃ² cá»§a cÃ¡c Docker image mÃ  báº¡n sá»­ dá»¥ng. Má»—i image nÃªn cÃ³ má»™t vai trÃ² duy nháº¥t. Náº¿u báº¡n Ä‘ang chuyá»ƒn cÃ¡c framework/thÆ° viá»‡n kiá»ƒm thá»­ Ä‘áº¿n mÃ´i trÆ°á»ng sáº£n xuáº¥t thÃ¬ báº¡n Ä‘ang lÃ m sai. Báº¡n cÅ©ng nÃªn dÃ nh má»™t chÃºt thá»i gian Ä‘á»ƒ tÃ¬m hiá»ƒu vÃ  sá»­ dá»¥ng [multi-stage builds](https://docs.docker.com/build/building/multi-stage/)

## Anti-pattern 5 - Sá»­ dá»¥ng cÃ¡c image khÃ¡c nhau cho tá»«ng mÃ´i trÆ°á»ng (qa, stage, production)

Má»™t trong nhá»¯ng lá»£i tháº¿ quan trá»ng nháº¥t cá»§a viá»‡c sá»­ dá»¥ng container lÃ  thuá»™c tÃ­nh báº¥t biáº¿n cá»§a chÃºng. Äiá»u nÃ y cÃ³ nghÄ©a lÃ  Docker image chá»‰ nÃªn Ä‘Æ°á»£c xÃ¢y dá»±ng má»™t láº§n vÃ  sau Ä‘Ã³ Ä‘Æ°á»£c chuyá»ƒn tá»›i cÃ¡c mÃ´i trÆ°á»ng khÃ¡c nhau cho Ä‘áº¿n khi nÃ³ tá»›i mÃ´i trÆ°á»ng sáº£n xuáº¥t.

![Sá»­ dá»¥ng cÃ¹ng má»™t docker image](/static/images/assets/docker_anti_patern_image-promotion-1.png)

Bá»Ÿi vÃ¬ vá»›i cÃ¡c image giá»‘ng nhau sáº½ Ä‘Æ°á»£c chuyá»ƒn tá»›i cÃ¡c mÃ´i trÆ°á»ng dÆ°á»›i dáº¡ng má»™t thá»±c thá»ƒ duy nháº¥t, báº¡n cÃ³ Ä‘Æ°á»£c Ä‘áº£m báº£o ráº±ng nhá»¯ng gÃ¬ báº¡n Ä‘ang thá»­ nghiá»‡m trong má»™t mÃ´i trÆ°á»ng giá»‘ng vá»›i mÃ´i trÆ°á»ng khÃ¡c.

TÃ´i tháº¥y ráº¥t nhiá»u cÃ´ng ty xÃ¢y dá»±ng cÃ¡c artifact khÃ¡c nhau cho tá»«ng mÃ´i trÆ°á»ng cá»§a há» vá»›i cÃ¡c phiÃªn báº£n hoáº·c cáº¥u hÃ¬nh khÃ¡c nhau.

![Sá»­ dá»¥ng image khÃ¡c nhau cho tá»«ng mÃ´i trÆ°á»ng](/static/images/assets/docker_anti_pattern_image-per-env-1.png)

Äiá»u nÃ y sáº½ phÃ¡t sinh váº¥n Ä‘á» vÃ¬ khÃ´ng cÃ³ gÃ¬ Ä‘áº£m báº£o ráº±ng cÃ¡c image â€œÄ‘á»§ giá»‘ng nhauâ€ vÃ  Ä‘áº£m báº£o chÃºng hoáº¡t Ä‘á»™ng giá»‘ng nhau. NÃ³ cÅ©ng má»Ÿ ra ráº¥t nhiá»u kháº£ nÄƒng láº¡m dá»¥ng, nÆ¡i cÃ¡c ká»¹ sÆ° phÃ¡t triá»ƒn/váº­n hÃ nh Ä‘ang lÃ©n sá»­ dá»¥ng cÃ¡c cÃ´ng cá»¥ gá»¡ lá»—i bá»• sung trong cÃ¡c image cá»§a mÃ´i trÆ°á»ng khÃ´ng sáº£n xuáº¥t, táº¡o ra sá»± khÃ¡c nhau tháº­m chÃ­ cÃ²n lá»›n hÆ¡n giá»¯a cÃ¡c image cho cÃ¡c mÃ´i trÆ°á»ng khÃ¡c nhau.

Thay vÃ¬ cá»‘ gáº¯ng Ä‘áº£m báº£o ráº±ng cÃ¡c image khÃ¡c nhau cá»§a báº¡n giá»‘ng nhau nháº¥t cÃ³ thá»ƒ, viá»‡c sá»­ dá»¥ng má»™t image duy nháº¥t cho táº¥t cáº£ cÃ¡c giai Ä‘oáº¡n vÃ²ng Ä‘á»i pháº§n má»m sáº½ dá»… dÃ ng hÆ¡n nhiá»u.

LÆ°u Ã½ ráº±ng hoÃ n toÃ n bÃ¬nh thÆ°á»ng náº¿u cÃ¡c mÃ´i trÆ°á»ng khÃ¡c nhau sá»­ dá»¥ng cÃ¡c cÃ i Ä‘áº·t khÃ¡c nhau (VD: cÃ¡c biáº¿n bÃ­ máº­t vÃ  biáº¿n cáº¥u hÃ¬nh) nhÆ° chÃºng ta sáº½ tháº¥y á»Ÿ pháº§n sau cá»§a bÃ i viáº¿t nÃ y. Tuy nhiÃªn, má»i thá»© khÃ¡c pháº£i hoÃ n toÃ n giá»‘ng nhau.

## Anti-pattern 6 - Táº¡o Docker image trÃªn mÃ¡y chá»§ sáº£n xuáº¥t

Docker registry Ä‘Ã³ng vai trÃ² lÃ  danh má»¥c cÃ¡c á»©ng dá»¥ng hiá»‡n cÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ triá»ƒn khai báº¥t ká»³ lÃºc nÃ o cho báº¥t ká»³ mÃ´i trÆ°á»ng nÃ o. NÃ³ cÅ©ng Ä‘Ã³ng vai trÃ² lÃ  trung tÃ¢m cá»§a cÃ¡c assets trong á»©ng dá»¥ng vá»›i cÃ¡c metadata cÃ¹ng vá»›i cÃ¡c phiÃªn báº£n cá»§a má»™t á»©ng dá»¥ng. Sáº½ ráº¥t dá»… dÃ ng Ä‘á»ƒ chá»n má»™t tag cá»¥ thá»ƒ cá»§a Docker image vÃ  triá»ƒn khai nÃ³ tá»›i báº¥t ká»³ mÃ´i trÆ°á»ng nÃ o.

Má»™t trong nhá»¯ng cÃ¡ch linh hoáº¡t nháº¥t Ä‘á»ƒ sá»­ dá»¥ng Docker registry lÃ  promote cÃ¡c Docker image giá»¯a cÃ¡c registry. Má»™t tá»• chá»©c cÃ³ Ã­t nháº¥t registry (mÃ´i trÆ°á»ng phÃ¡t triá»ƒn vÃ  mÃ´i trÆ°á»ng sáº£n xuáº¥t). Docker image nÃªn Ä‘Æ°á»£c táº¡o má»™t láº§n (xem anti-pattern trÆ°á»›c) vÃ  Ä‘Æ°á»£c Ä‘áº·t á»Ÿ registry cho mÃ´i trÆ°á»ng phÃ¡t triá»ƒn. Sau Ä‘Ã³, khi image vÆ°á»£t qua cÃ¡c bÃ i kiá»ƒm tra tÃ­ch há»£p, quÃ©t báº£o máº­t vÃ  cÃ¡c kiá»ƒm tra cháº¥t lÆ°á»£ng, nÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c promote vÃ o Docker registry cá»§a mÃ´i trÆ°á»ng sáº£n xuáº¥t Ä‘á»ƒ Ä‘Æ°á»£c gá»­i Ä‘áº¿n mÃ¡y chá»§ sáº£n xuáº¥t hoáº·c Kubernetes cluster.

CÅ©ng cÃ³ thá»ƒ cÃ³ cÃ¡c tá»• chá»©c khÃ¡c nhau cÃ³ cÃ¡c Docker registry theo khu vá»±c/vá»‹ trÃ­ hoáº·c theo bá»™ pháº­n. Äiá»ƒm chÃ­nh á»Ÿ Ä‘Ã¢y lÃ  tiÃªu chuáº©n cho viá»‡c triá»ƒn khai Docker image sáº½ bao gá»“m Docker registry. CÃ¡c Docker registry vá»«a Ä‘Ã³ng vai trÃ² lÃ  kho lÆ°u trá»¯ ná»™i dung á»©ng dá»¥ng vá»«a lÃ  nÆ¡i lÆ°u trá»¯ trung gian trÆ°á»›c khi má»™t á»©ng dá»¥ng Ä‘Æ°á»£c triá»ƒn khai vÃ o mÃ´i trÆ°á»ng sáº£n xuáº¥t.

Tuy nhiÃªn cÃ³ má»™t thá»±c hÃ nh khÃ´ng tá»‘t lÃ  viá»‡c loáº¡i bá» hoÃ n toÃ n cÃ¡c Docker registry khá»i vÃ²ng Ä‘á»i cá»§a image vÃ  Ä‘áº©y mÃ£ nguá»“n trá»±c tiáº¿p Ä‘áº¿n cÃ¡c mÃ¡y chá»§ sáº£n xuáº¥t.

![XÃ¢y dá»±ng image trong mÃ¡y chá»§ sáº£n xuáº¥t](/static/images/assets/docker_anti_pattern_6_dont.png)

MÃ¡y chá»§ sáº£n xuáº¥t sá»­ dá»¥ng `git pull` Ä‘á»ƒ láº¥y mÃ£ nguá»“n vÃ  sau Ä‘Ã³ xÃ¢y dá»±ng Docker Ä‘á»ƒ táº¡o má»™t image nhanh chÃ³ng vÃ  cháº¡y nÃ³ (thÆ°á»ng vá»›i `docker-compose` hoáº·c cÃ¡c orchestration khÃ¡c). "PhÆ°Æ¡ng phÃ¡p triá»ƒn khai" nÃ y vá» cÆ¡ báº£n sá»­ dá»¥ng anti-pattern cÃ¹ng má»™t lÃºc!

QuÃ¡ trÃ¬nh triá»ƒn khai nÃ y gáº·p pháº£i ráº¥t nhiá»u váº¥n Ä‘á», báº¯t Ä‘áº§u tá»« váº¥n Ä‘á» báº£o máº­t. MÃ¡y chá»§ sáº£n xuáº¥t khÃ´ng Ä‘Æ°á»£c cÃ³ quyá»n truy cáº­p vÃ o kho git repositories cá»§a báº¡n. Náº¿u má»™t cÃ´ng ty nghiÃªm tÃºc vá» báº£o máº­t, mÃ´ hÃ¬nh nÃ y tháº­m chÃ­ sáº½ khÃ´ng Ä‘Æ°á»£c thÃ´ng qua táº¡i nhÃ³m báº£o máº­t. MÃ¡y chá»§ sáº£n xuáº¥t khÃ´ng cÃ³ báº¥t cá»© lÃ½ do nÃ o Ä‘á»ƒ cÃ i Ä‘áº·t git. Git (hoáº·c báº¥t ká»³ há»‡ thá»‘ng kiá»ƒm soÃ¡t phiÃªn báº£n nÃ o khÃ¡c) lÃ  má»™t cÃ´ng cá»¥ dÃ nh cho sá»± cá»™ng tÃ¡c cá»§a nhÃ³m phÃ¡t triá»ƒn vÃ  khÃ´ng pháº£i lÃ  má»™t giáº£i phÃ¡p phÃ¢n phá»‘i.

NhÆ°ng váº¥n Ä‘á» quan trá»ng nháº¥t lÃ  vá»›i "phÆ°Æ¡ng phÃ¡p triá»ƒn khai" nÃ y, báº¡n bá» qua hoÃ n toÃ n Docker registry. Báº¡n khÃ´ng cÃ²n biáº¿t Docker image nÃ o Ä‘Æ°á»£c triá»ƒn khai trÃªn mÃ¡y chá»§ cá»§a mÃ¬nh vÃ¬ khÃ´ng cÃ²n trung tÃ¢m lÆ°u giá»¯ Docker images ná»¯a.

PhÆ°Æ¡ng phÃ¡p triá»ƒn khai nÃ y cÃ³ thá»ƒ hoáº¡t Ä‘á»™ng tá»‘t vá»›i má»™t start up, nhÆ°ng sáº½ nhanh chÃ³ng trá»Ÿ nÃªn kÃ©m hiá»‡u quáº£ khi cÃ¡c báº£n cÃ i Ä‘áº·t trá»Ÿ nÃªn lá»›n hÆ¡n. Báº¡n cáº§n tÃ¬m hiá»ƒu cÃ¡ch sá»­ dá»¥ng Docker registry vÃ  nhá»¯ng lá»£i Ã­ch mÃ  chÃºng mang láº¡i (cÅ©ng liÃªn quan Ä‘áº¿n viá»‡c quÃ©t báº£o máº­t cÃ¡c containers).

![Sá»­ dá»¥ng Docker registry](/static/images/assets/docker_anti_pattern_docker_registry.png)

Docker registry cÃ³ má»™t API ráº¥t rÃµ rÃ ng vÃ  cÃ³ má»™t sá»‘ sáº£n pháº©m mÃ£ nguá»“n má»Ÿ cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ thiáº¿t láº­p registry trong tá»• chá»©c cá»§a báº¡n.

CÅ©ng lÆ°u Ã½ ráº±ng vá»›i Docker registry mÃ£ nguá»“n cá»§a báº¡n náº±m an toÃ n phÃ­a sau tÆ°á»ng lá»­a vÃ  khÃ´ng bao giá» rá»i khá»i nÃ³.

## Anti-pattern 7 - LÃ m viá»‡c vá»›i git hash thay vÃ¬ Docker image

Há»‡ quáº£ cá»§a hai anti-pattern trÆ°á»›c Ä‘Ã³ lÃ  khi báº¡n sá»­ dá»¥ng container, Docker registry cá»§a báº¡n sáº½ trá»Ÿ thÃ nh single point of truth cho má»i thá»©. Má»i ngÆ°á»i nÃªn nÃ³i vá» Docker tags vÃ  image Ä‘Æ°á»£c promote. NhÃ³m phÃ¡t triá»ƒn vÃ  nhÃ³m váº­n hÃ nh nÃªn sá»­ dá»¥ng container lÃ m ngÃ´n ngá»¯ chung cá»§a há». Thá»© Ä‘Æ°á»£c chuyá»ƒn giao giá»¯a cÃ¡c nhÃ³m pháº£i lÃ  má»™t container chá»© khÃ´ng pháº£i má»™t git hash.

![NÃ³i vá» git hash](/static/images/assets/docker_anti_pattern_talk_git_hash.png)

Äiá»u nÃ y trÃ¡i ngÆ°á»£c vá»›i cÃ¡ch cÅ© sá»­ dá»¥ng git hash nhÆ° lÃ  má»™t artifact Ä‘Æ°á»£c promote. MÃ£ nguá»“n táº¥t nhiÃªn lÃ  ráº¥t quan trá»ng, nhÆ°ng viá»‡c xÃ¢y dá»±ng láº¡i nhiá»u láº§n cÃ¹ng má»™t hash Ä‘á»ƒ promote lÃ  má»™t sá»± lÃ£ng phÃ­ tÃ i nguyÃªn (xem thÃªm anti-pattern 5). Má»™t sá»‘ cÃ´ng ty nghÄ© ráº±ng cÃ¡c container chá»‰ nÃªn Ä‘Æ°á»£c xá»­ lÃ½ nhÃ³m váº¥n hÃ nh cÃ²n nhÃ³m phÃ¡t triá»ƒn chá»‰ lÃ m viá»‡c vá»›i mÃ£ nguá»“n. Äiá»u nÃ y khÃ¡c xa sá»± tháº­t. Container lÃ  cÆ¡ há»™i hoÃ n háº£o cho nhÃ³m phÃ¡t triá»ƒn vÃ  nhÃ³m Ä‘iá»u hÃ nh lÃ m viá»‡c cÃ¹ng nhau.

![NÃ³i vá» container](/static/images/assets/docker_anti_pattern_talk_container.png)

LÃ½ tÆ°á»Ÿng nháº¥t lÃ  nhÃ³m váº­n hÃ nh tháº­m chÃ­ khÃ´ng nÃªn quan tÃ¢m Ä‘áº¿n nhá»¯ng gÃ¬ Ä‘ang diá»…n ra vá»›i git repo cá»§a má»™t á»©ng dá»¥ng. Táº¥t cáº£ nhá»¯ng gÃ¬ há» cáº§n biáº¿t lÃ  liá»‡u Docker image mÃ  há» cÃ³ trong tay Ä‘Ã£ sáºµn sÃ ng Ä‘á»ƒ Ä‘Æ°a vÃ o mÃ´i trÆ°á»ng sáº£n xuáº¥t hay chÆ°a. Há» khÃ´ng nÃªn bá»‹ báº¯t pháº£i xÃ¢y dá»±ng láº¡i má»™t git hash Ä‘á»ƒ cÃ³ Ä‘Æ°á»£c Docker image giá»‘ng nhÆ° nhÃ³m phÃ¡t triá»ƒn Ä‘ang sá»­ dá»¥ng trong mÃ´i trÆ°á»ng tiá»n sáº£n xuáº¥t.

Báº¡n cÃ³ thá»ƒ hiá»ƒu liá»‡u mÃ¬nh cÃ³ pháº£i lÃ  náº¡n nhÃ¢n cá»§a anti-pattern nÃ y hay khÃ´ng báº±ng cÃ¡ch há»i nhÃ³m váº­n hÃ nh trong tá»• chá»©c cá»§a báº¡n.
Náº¿u há» bá»‹ buá»™c pháº£i lÃ m quen vá»›i cÃ¡c á»©ng dá»¥ng ná»™i bá»™ nhÆ° há»‡ thá»‘ng xÃ¢y dá»±ng hoáº·c framework kiá»ƒm thá»­, nhá»¯ng thá»© thÆ°á»ng khÃ´ng liÃªn quan Ä‘áº¿n runtime cá»§a á»©ng dá»¥ng, há» sáº½ cÃ³ nhá»¯ng cÃ´ng viá»‡c náº·ng ná» mÃ  khÃ´ng cáº§n thiáº¿t hÃ ng ngÃ y.

## Anti-pattern 8 - Hard-code cÃ¡c giÃ¡ trá»‹ bÃ­ máº­t vÃ  cáº¥u hÃ¬nh trong Docker image

Anti-pattern nÃ y cÃ³ liÃªn quan cháº·t cháº½ vá»›i Anti-pattern 5 (cÃ¡c image khÃ¡c nhau trÃªn má»—i mÃ´i trÆ°á»ng). Trong háº§u háº¿t cÃ¡c trÆ°á»ng há»£p khi tÃ´i há»i cÃ¡c cÃ´ng ty táº¡i sao há» cáº§n cÃ¡c image khÃ¡c nhau cho qa/stage/prod, cÃ¢u tráº£ lá»i thÃ´ng thÆ°á»ng lÃ  chÃºng chá»©a cÃ¡c cáº¥u hÃ¬nh vÃ  giÃ¡ trá»‹ bÃ­ máº­t khÃ¡c nhau.

Äiá»u nÃ y khÃ´ng chá»‰ phÃ¡ vá»¡ lá»i há»©a chÃ­nh cá»§a Docker (triá»ƒn khai nhá»¯ng gÃ¬ báº¡n Ä‘Ã£ thá»­ nghiá»‡m) mÃ  cÃ²n lÃ m cho táº¥t cáº£ cÃ¡c Ä‘Æ°á»ng á»‘ng CI/CD trá»Ÿ nÃªn ráº¥t phá»©c táº¡p vÃ¬ chÃºng pháº£i quáº£n lÃ½ bÃ­ máº­t/cáº¥u hÃ¬nh trong thá»i gian xÃ¢y dá»±ng (build-time)

Táº¥t nhiÃªn, chá»‘ng láº¡i mÃ´ hÃ¬nh á»Ÿ Ä‘Ã¢y lÃ  hard-code cÃ¡c cáº¥u hÃ¬nh. CÃ¡c á»©ng dá»¥ng khÃ´ng Ä‘Æ°á»£c cÃ³ cáº¥u hÃ¬nh nhÃºng cÃ¹ng vá»›i chÃºng. Äiá»u nÃ y khÃ´ng má»›i vá»›i báº¥t ká»³ ai Ä‘Ã£ quen thuá»™c vá»›i [12-factor apps](https://12factor.net/vi/config)

![Cáº¥u hÃ¬nh hard-code táº¡i thá»i Ä‘iá»ƒm xÃ¢y dá»±ng](/static/images/assets/docker_anti_pattern_hardcode.png)

CÃ¡c á»©ng dá»¥ng cá»§a báº¡n nÃªn tÃ¬m náº¡p cáº¥u hÃ¬nh trong thá»i gian cháº¡y (run-time) thay vÃ¬ thá»i gian xÃ¢y dá»±ng (build-time). Docker image pháº£i lÃ  cáº¥u hÃ¬nh báº¥t kháº£ tri (agnostic). Chá»‰ cáº¥u hÃ¬nh trong thá»i gian cháº¡y má»›i Ä‘Æ°á»£c "Ä‘Ã­nh kÃ¨m" vÃ o container. Äá»‘i vá»›i cáº¥u hÃ¬nh thá»i gian cháº¡y (configmaps, zookeeper, consul, v.v.) vÃ  bÃ­ máº­t (vault, keywhiz , tÃ¢m sá»±, cerberus).

Äang táº£i cáº¥u hÃ¬nh trong thá»i gian cháº¡y
Äang táº£i cáº¥u hÃ¬nh trong thá»i gian cháº¡y
Náº¿u image Docker cá»§a báº¡n cÃ³ cÃ¡c IP vÃ  / hoáº·c thÃ´ng tin xÃ¡c thá»±c Ä‘Æ°á»£c mÃ£ hÃ³a cá»©ng, báº¡n cháº¯c cháº¯n Ä‘ang lÃ m sai.

CÃ¡c á»©ng dá»¥ng cá»§a báº¡n nÃªn tÃ¬m náº¡p cáº¥u hÃ¬nh trong thá»i gian cháº¡y thay vÃ¬ thá»i gian xÃ¢y dá»±ng. image Docker pháº£i lÃ  cáº¥u hÃ¬nh báº¥t kháº£ tri. Chá»‰ trong khi cáº¥u hÃ¬nh thá»i gian cháº¡y má»›i Ä‘Æ°á»£c "Ä‘Ã­nh kÃ¨m" vÃ o container. CÃ³ nhiá»u giáº£i phÃ¡p cho viá»‡c nÃ y vÃ  háº§u háº¿t cÃ¡c há»‡ thá»‘ng phÃ¢n cá»¥m hoáº·c há»‡ thá»‘ng triá»ƒn khai Ä‘á»u cÃ³ thá»ƒ hoáº¡t Ä‘á»™ng vá»›i cÃ¡c giáº£i phÃ¡p cho cáº¥u hÃ¬nh trong thá»i gian cháº¡y ([configmaps](https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/), [Zookeeper](https://zookeeper.apache.org/), [consul](https://www.consul.io/), v.v.) hay giÃ¡ trá»‹ bÃ­ máº­t ([vault](https://www.vaultproject.io/), [keywhiz](https://square.github.io/keywhiz/), [confidant](https://lyft.github.io/confidant/), [cerberus](https://engineering.nike.com/cerberus/)).

![Äang táº£i cáº¥u hÃ¬nh trong thá»i gian cháº¡y](/static/images/assets/docker_anti_pattern_runtime_conf.png)

Náº¿u image Docker cá»§a báº¡n cÃ³ cÃ¡c IP hoáº·c/vÃ  thÃ´ng tin xÃ¡c thá»±c Ä‘Æ°á»£c hard-code, báº¡n cháº¯c cháº¯n Ä‘ang lÃ m sai.

## Anti-pattern 9 - Táº¡o Dockerfile lÃ m quÃ¡ nhiá»u thá»©

TÃ´i Ä‘Ã£ xem qua cÃ¡c bÃ i bÃ¡o Ä‘á» xuáº¥t ráº±ng Dockerfile nÃªn Ä‘Æ°á»£c sá»­ dá»¥ng nhÆ° má»™t giáº£i phÃ¡p CI cho ngÆ°á»i nghÃ¨o. ÄÃ¢y lÃ  má»™t vÃ­ dá»¥ thá»±c táº¿ vá» má»™t Dockerfile duy nháº¥t.

```yaml
# Run Sonar analysis
FROM newtmitch/sonar-scanner AS sonar
COPY src src
RUN sonar-scanner
# Build application
FROM node:11 AS build
WORKDIR /usr/src/app
COPY . .
RUN yarn install \
 yarn run lint \
 yarn run build \
 yarn run generate-docs
LABEL stage=build
# Run unit test
FROM build AS unit-tests
RUN yarn run unit-tests
LABEL stage=unit-tests
# Push docs to S3
FROM containerlabs/aws-sdk AS push-docs
ARG push-docs=false
COPY --from=build docs docs
RUN [[ "$push-docs" == true ]] && aws s3 cp -r docs s3://my-docs-bucket/
# Build final app
FROM node:11-slim
EXPOSE 8080
WORKDIR /usr/src/app
COPY --from=build /usr/src/app/node_modules node_modules
COPY --from=build /usr/src/app/dist dist
USER node
CMD ["node", "./dist/server/index.js"]
```

DÃ¹ thoáº¡t nhÃ¬n, Dockerfile nÃ y cÃ³ thá»ƒ trÃ´ng giá»‘ng nhÆ° má»™t cÃ¡ch sá»­ dá»¥ng tá»‘t cá»§a multi-stages build, nhÆ°ng vá» cÆ¡ báº£n nÃ³ lÃ  sá»± káº¿t há»£p cá»§a cÃ¡c anti-pattern trÆ°á»›c Ä‘Ã³.

NÃ³ giáº£ Ä‘á»‹nh sá»± hiá»‡n diá»‡n cá»§a má»™t mÃ¡y chá»§ SonarQube (anti-pattern 2).
NÃ³ cÃ³ nhá»¯ng tÃ¡c dá»¥ng phá»¥ tiá»m áº©n vÃ¬ nÃ³ cÃ³ thá»ƒ Ä‘áº©y file lÃªn S3 (anti-pattern 3).
NÃ³ vá»«a Ä‘Ã³ng vai trÃ² lÃ  image dÃ¹ng Ä‘á»ƒ phÃ¡t triá»ƒn vá»«a lÃ  image dÃ¹ng Ä‘á»ƒ triá»ƒn khai (anti-pattern 4).

Docker khÃ´ng pháº£i lÃ  má»™t há»‡ thá»‘ng CI. CÃ´ng nghá»‡ container cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng nhÆ° má»™t pháº§n cá»§a Ä‘Æ°á»ng á»‘ng CI/CD, nhÆ°ng ká»¹ thuáº­t nÃ y lÃ  má»™t cÃ¡i gÃ¬ Ä‘Ã³ hoÃ n toÃ n khÃ¡c. Äá»«ng nháº§m láº«n cÃ¡c lá»‡nh cáº§n cháº¡y trong Docker container vá»›i cÃ¡c lá»‡nh cáº§n cháº¡y trong má»™t CI build job.

[TÃ¡c giáº£ cá»§a Dockerfile nÃ y cho ráº±ng](https://itnext.io/shift-your-ci-scripts-to-docker-build-92453bca9f75) báº¡n nÃªn sá»­ dá»¥ng cÃ¡c Ä‘á»‘i sá»‘ Ä‘á»ƒ tÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c nhÃ£n vÃ  thá»±c hiá»‡n/bá» qua cÃ¡c giai Ä‘oáº¡n build cá»¥ thá»ƒ (VD: báº¡n cÃ³ thá»ƒ táº¯t sonar). NhÆ°ng cÃ¡ch tiáº¿p cáº­n nÃ y chá»‰ lÃ  thÃªm phá»©c táº¡p hÆ¡n thay vÃ¬ lÃ m má»i thá»© Ä‘Æ¡n giáº£n, tiá»‡n lá»£i hÆ¡n.

CÃ¡ch kháº¯c phá»¥c Dockerfile nÃ y lÃ  chia nhá» thÃ nh 5 Dockerfile khÃ¡c. Má»™t Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ triá»ƒn khai á»©ng dá»¥ng vÃ  táº¥t cáº£ cÃ¡c tá»‡p khÃ¡c lÃ  cÃ¡c bÆ°á»›c khÃ¡c nhau trong Ä‘Æ°á»ng á»‘ng CI/CD cá»§a báº¡n. Má»™t Dockerfile duy nháº¥t nÃªn cÃ³ má»™t má»¥c Ä‘Ã­ch/má»¥c tiÃªu duy nháº¥t.

## Anti-pattern 10 - Táº¡o tá»‡p Docker quÃ¡ Ä‘Æ¡n giáº£n

Bá»Ÿi vÃ¬ container cÅ©ng bao gá»“m cÃ¡c pháº§n dependency cá»§a chÃºng, chÃºng thÆ°á»ng Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ cÃ´ láº­p cÃ¡c phiÃªn báº£n cho cÃ¡c thÆ° viá»‡n vÃ  framework cho cÃ¡c á»©ng dá»¥ng. CÃ¡c nhÃ  phÃ¡t triá»ƒn Ä‘Ã£ quÃ¡ quen vá»›i váº¥n Ä‘á» khi cá»‘ gáº¯ng cÃ i Ä‘áº·t nhiá»u phiÃªn báº£n khÃ¡c nhau cá»§a cÃ¹ng má»™t cÃ´ng cá»¥ trÃªn mÃ¡y tráº¡m cá»§a há». Docker há»©a háº¹n sáº½ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y báº±ng cÃ¡ch cho phÃ©p báº¡n mÃ´ táº£ trong Dockerfile cá»§a báº¡n chÃ­nh xÃ¡c nhá»¯ng gÃ¬ á»©ng dá»¥ng cá»§a báº¡n cáº§n vÃ  khÃ´ng cÃ³ gÃ¬ khÃ¡c.

NhÆ°ng nÃ³ chá»‰ Ä‘Ãºng náº¿u báº¡n thá»±c sá»± tuÃ¢n thá»§ nÃ³. LÃ  má»™t ká»¹ sÆ° váº­n hÃ nh, báº¡n khÃ´ng thá»±c sá»± quan tÃ¢m Ä‘áº¿n cÃ´ng cá»¥ láº­p trÃ¬nh báº¡n sá»­ dá»¥ng trong image Docker cá»§a mÃ¬nh. TÃ´i cÃ³ thá»ƒ táº¡o image Docker cá»§a má»™t á»©ng dá»¥ng Java, sau Ä‘Ã³ lÃ  Python má»™t vÃ  sau Ä‘Ã³ lÃ  má»™t NodeJs, mÃ  khÃ´ng thá»±c sá»± cÃ³ mÃ´i trÆ°á»ng phÃ¡t triá»ƒn cho tá»«ng ngÃ´n ngá»¯ trÃªn mÃ¡y tÃ­nh xÃ¡ch tay cá»§a tÃ´i.

Tuy nhiÃªn, nhiá»u cÃ´ng ty váº«n xem Docker lÃ  má»™t Ä‘á»‹nh dáº¡ng gÃ³i vÃ  chá»‰ sá»­ dá»¥ng nÃ³ Ä‘á»ƒ Ä‘Ã³ng gÃ³i má»™t artifact/á»©ng dá»¥ng hoÃ n chá»‰nh Ä‘Ã£ Ä‘Æ°á»£c táº¡o bÃªn ngoÃ i container. Anti-pattern nÃ y ráº¥t ná»•i tiáº¿ng vá»›i cÃ¡c tá»• chá»©c sá»­ dá»¥ng Java rá»™ng rÃ£i vÃ  ngay cáº£ tÃ i liá»‡u chÃ­nh thá»©c dÆ°á»ng nhÆ° cÅ©ng quáº£ng bÃ¡ nÃ³.

ÄÃ¢y lÃ  Dockerfile Ä‘Æ°á»£c Ä‘á» xuáº¥t tá»« hÆ°á»›ng dáº«n chÃ­nh thá»©c cá»§a [Spring Boot Docker](https://spring.io/guides/gs/spring-boot-docker/).

```yaml
FROM openjdk:8-jdk-alpine
VOLUME /tmp
ARG JAR_FILE
COPY ${JAR_FILE} app.jar
ENTRYPOINT ["java","-Djava.security.egd=file:/dev/./urandom","-jar","/app.jar"]
```

Dockerfile nÃ y chá»‰ Ä‘Ã³ng gÃ³i má»™t tá»‡p jar hiá»‡n cÃ³. Tá»‡p Jar Ä‘Æ°á»£c táº¡o nhÆ° tháº¿ nÃ o? KhÃ´ng ai biáº¿t. NÃ³ khÃ´ng Ä‘Æ°á»£c mÃ´ táº£ trong Dockerfile. Náº¿u tÃ´i lÃ  ngÆ°á»i váº­n hÃ nh, tÃ´i buá»™c pháº£i cÃ i Ä‘áº·t táº¥t cáº£ cÃ¡c thÆ° viá»‡n phÃ¡t triá»ƒn Java chá»‰ Ä‘á»ƒ táº¡o Dockerfile nÃ y. Náº¿u báº¡n lÃ m viá»‡c trong má»™t tá»• chá»©c lÃ m viá»‡c vá»›i nhiá»u ngÃ´n ngá»¯ láº­p trÃ¬nh, quÃ¡ trÃ¬nh nÃ y nhanh chÃ³ng vÆ°á»£t ra khá»i táº§m kiá»ƒm soÃ¡t khÃ´ng chá»‰ Ä‘á»‘i vá»›i cÃ¡c ká»¹ sÆ° váº­n hÃ nh mÃ  cÃ²n Ä‘á»‘i vá»›i build nodes.

TÃ´i sá»­ dá»¥ng Java lÃ m vÃ­ dá»¥ nhÆ°ng anti-pattern nÃ y cÅ©ng xuáº¥t hiá»‡n trong cÃ¡c tÃ¬nh huá»‘ng khÃ¡c. Dockerfiles khÃ´ng hoáº¡t Ä‘á»™ng náº¿u báº¡n khÃ´ng "cÃ i Ä‘áº·t npm" trÃªn mÃ¡y cá»§a báº¡n trong láº§n Ä‘áº§u tiÃªn lÃ  má»™t sá»± cá»‘ ráº¥t phá»• biáº¿n.

Giáº£i phÃ¡p cho anti-pattern nÃ y cÅ©ng giá»‘ng nhÆ° Ä‘á»‘i vá»›i anti-pattern 2 (cÃ¡c tá»‡p Docker khÃ´ng Ä‘á»™c láº­p). HÃ£y Ä‘áº£m báº£o ráº±ng cÃ¡c tá»‡p Dockerfiles cá»§a báº¡n mÃ´ táº£ toÃ n bá»™ quy trÃ¬nh cá»§a má»™t thá»© gÃ¬ Ä‘Ã³. CÃ¡c nhÃ  váº­n hÃ nh/SRE cá»§a báº¡n sáº½ yÃªu báº¡n hÆ¡n ná»¯a náº¿u báº¡n tuÃ¢n thá»§ Ä‘iá»u nÃ y. Trong trÆ°á»ng há»£p cá»§a vÃ­ dá»¥ Java trÆ°á»›c Dockerfile nÃªn Ä‘Æ°á»£c sá»­a Ä‘á»•i nhÆ° sau:

```yaml
FROM openjdk:8-jdk-alpine
COPY pom.xml /tmp/
COPY src /tmp/src/
WORKDIR /tmp/
RUN ./gradlew build
COPY  /tmp/build/app.war /app.jar
ENTRYPOINT ["java","-Djava.security.egd=file:/dev/./urandom","-jar","/app.jar"]
```

Dockerfile nÃ y mÃ´ táº£ chÃ­nh xÃ¡c cÃ¡ch á»©ng dá»¥ng Ä‘Æ°á»£c táº¡o vÃ  cÃ³ thá»ƒ Ä‘Æ°á»£c cháº¡y bá»Ÿi báº¥t ká»³ ai trÃªn báº¥t ká»³ mÃ¡y tráº¡m nÃ o mÃ  khÃ´ng cáº§n cÃ i Ä‘áº·t Java cá»¥c bá»™. Báº¡n cÃ³ thá»ƒ cáº£i thiá»‡n Dockerfile nÃ y hÆ¡n ná»¯a vá»›i multi-stage builds (bÃ i táº­p cho báº¡n Ä‘Ã³!).

## Tá»•ng káº¿t

Ráº¥t nhiá»u cÃ´ng ty gáº·p khÃ³ khÄƒn khi Ã¡p dá»¥ng container vÃ¬ há» cá»‘ gáº¯ng váº­n dá»¥ng cÃ¡c phÆ°Æ¡ng thá»©c hiá»‡n cÃ³ vá»›i VM vÃ o cÃ¡c container. Tá»‘t nháº¥t lÃ  dÃ nh má»™t chÃºt thá»i gian Ä‘á»ƒ nghÄ© láº¡i nhá»¯ng lá»£i tháº¿ mÃ  container cÃ³ vÃ  hiá»ƒu cÃ¡ch báº¡n cÃ³ thá»ƒ táº¡o quy trÃ¬nh cá»§a mÃ¬nh tá»« Ä‘áº§u vá»›i kiáº¿n thá»©c má»›i vá» cÃ´ng nghá»‡ nÃ y.

Trong hÆ°á»›ng dáº«n nÃ y, tÃ´i Ä‘Ã£ trÃ¬nh bÃ y má»™t sá»‘ phÆ°Æ¡ng phÃ¡p khÃ´ng tá»‘t khi lÃ m viá»‡c/sá»­ dá»¥ng container vÃ  giáº£i phÃ¡p cho tá»«ng phÆ°Æ¡ng phÃ¡p.

1. Cá»‘ gáº¯ng sá»­ dá»¥ng cÃ¡c phÆ°Æ¡ng phÃ¡p cá»§a VM trÃªn container -> Cá»‘ gáº¯ng hiá»ƒu container lÃ  gÃ¬.
2. Táº¡o tá»‡p Docker khÃ´ng trong suá»‘t -> Viáº¿t Dockerfile tá»« Ä‘áº§u thay vÃ¬ sá»­ dá»¥ng láº¡i cÃ¡c táº­p lá»‡nh hiá»‡n cÃ³.
3. Táº¡o Dockerfiles cÃ³ tÃ¡c dá»¥ng phá»¥ bÃªn ngoÃ i -> Chuyá»ƒn tÃ¡c dá»¥ng phá»¥ sang CI/CD cá»§a báº¡n vÃ  giá»¯ cho Dockerfiles khÃ´ng gÃ¢y ra tÃ¡c dá»¥ng phá»¥.
4. Image Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ triá»ƒn khai bá»‹ nháº§m láº«n vá»›i nhá»¯ng image Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ phÃ¡t triá»ƒn -> KhÃ´ng Ä‘Æ°a cÃ¡c cÃ´ng cá»¥ phÃ¡t triá»ƒn vÃ  framework kiá»ƒm thá»­ vÃ o mÃ¡y chá»§ sáº£n xuáº¥t.
5. XÃ¢y dá»±ng image khÃ¡c nhau cho má»—i mÃ´i trÆ°á»ng -> Chá»‰ xÃ¢y dá»±ng image má»™t láº§n vÃ  promote image Ä‘Ã³ trÃªn cÃ¡c mÃ´i trÆ°á»ng khÃ¡c nhau
6. KÃ©o mÃ£ tá»« mÃ¡y chá»§ sáº£n xuáº¥t báº±ng git vÃ  xÃ¢y dá»±ng image on-the-fly -> Sá»­ dá»¥ng Docker registry
7. Giao tiáº¿p giá»¯a cÃ¡c nhÃ³m sá»­ dá»¥ng git hash thay vÃ¬ docker image -> Sá»­ dá»¥ng/giao tiáº¿p báº±ng image container giá»¯a cÃ¡c nhÃ³m
8. Hard-code cÃ¡c giÃ¡ trá»‹ bÃ­ máº­t trong container image -> Táº¡o image má»™t láº§n duy nháº¥t vÃ  inject cáº¥u hÃ¬nh/giÃ¡ trá»‹ bÃ­ máº­t táº¡i run-time
9. Sá»­ dá»¥ng Docker lÃ m CI/CD -> Sá»­ dá»¥ng Docker lÃ m artifact triá»ƒn khai vÃ  chá»n giáº£i phÃ¡p CI/CD cho CI/CD
10. Coi container lÃ  má»™t phÆ°Æ¡ng phÃ¡p Ä‘Ã³ng gÃ³i tiá»‡n lá»£i -> Táº¡o Dockerfiles tá»± biÃªn dá»‹ch/Ä‘Ã³ng gÃ³i mÃ£ nguá»“n tá»« Ä‘áº§u.

Xem xÃ©t quy trÃ¬nh lÃ m viá»‡c cá»§a báº¡n, há»i ká»¹ sÆ° phÃ¡t triá»ƒn (náº¿u báº¡n lÃ  ká»¹ sÆ° váº­n hÃ nh) hoáº·c ká»¹ sÆ° váº­n hÃ nh (náº¿u báº¡n lÃ  ká»¹ sÆ° phÃ¡t triá»ƒn) vÃ  cá»‘ gáº¯ng tÃ¬m xem liá»‡u cÃ´ng ty cá»§a báº¡n cÃ³ Ä‘ang lÃ m má»™t hoáº·c nhiá»u anti-pattern nÃ y hay khÃ´ng.

Báº¡n cÃ³ biáº¿t báº¥t ká»³ thá»±c hÃ nh container tá»‘t/xáº¥u nÃ o khÃ¡c khÃ´ng? Náº¿u cÃ³, hÃ£y Ä‘á»ƒ láº¡i comment á»Ÿ cuá»‘i bÃ i nhÃ©!

## Tham kháº£o

- [Docker anti-patterns](https://codefresh.io/blog/docker-anti-patterns/)

## VNTechies Dev Blog

Kho tÃ i nguyÃªn mÃ£ nguá»“n má»Ÿ vá»›i sá»© má»‡nh Ä‘Ã o táº¡o kiáº¿n thá»©c, Ä‘á»‹nh hÆ°á»›ng nghá» nghiá»‡p cho cá»™ng Ä‘á»“ng Cloud â˜ï¸ DevOps ğŸš€

[![Facebook page](https://i.imgur.com/YxfhUTS.png)](https://www.facebook.com/vntechies)

Tham gia group [VNTechies - Cloud â˜ï¸ / DevOps ğŸš€](https://www.facebook.com/groups/acevntechies) náº¿u báº¡n muá»‘n giao lÆ°u vá»›i cá»™ng Ä‘á»“ng vÃ  cáº­p nháº­t cÃ¡c thÃ´ng tin má»›i nháº¥t vá» Cloud vÃ  DevOps.

- Website: https://vntechies.dev
- Github repository: https://github.com/vntechies
- Facebook page: https://facebook.com/vntechies

[![Discord banner](https://images.viblo.asia/c8c4a473-c08d-45a3-be57-821781c1c256.png)](https://discord.com/invite/k2uDgd7NZ4)

Anh chá»‹ em hÃ£y follow/á»§ng há»™ VNTechies Ä‘á»ƒ cáº­p nháº­t nhá»¯ng thÃ´ng tin má»›i nháº¥t vá» Cloud vÃ  DevOps nhÃ©!
