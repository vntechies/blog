---
title: Crawl d·ªØ li·ªáu t·ª∑ gi√° h·ªëi ƒëo√°i v·ªõi AWS Lambda v√† DynamoDB (Over engineer version)
date: '2022-08-12'
tags:
  [
    'aws',
    'crawler',
    's3',
    'lambda',
    'automation',
    'eventbridge',
    'serverless',
    'python',
    'selenium',
  ]
draft: false
authors: ['mau']
images: ['/static/images/ogps/currency-crawler.png']
summary: 'Crawler ƒë∆°n gi·∫£n ph·ª•c v·ª• cho vi·ªác l·∫•y d·ªØ li·ªáu t·ª∑ gi√° h·ªëi ƒëo√°i c·ªßa c√°c ng√¢n h√†ng Vi·ªát Nam'
---

![Currency Crawler](/static/images/ogps/currency-crawler.png)

<TOCInline toc={props.toc} asDisclosure />

## TL;DR

Gi·∫£i ph√°p ƒë∆°n gi·∫£n cho y√™u c·∫ßu crawl d·ªØ li·ªáu ƒë∆°n gi·∫£n üòÖ

## Y√™u c·∫ßu

M·ªôt ng√†y ƒë·∫πp tr·ªùi, b√† ch·ªã g√°i y√™u d·∫•u c·ªßa t√¥i c√≥ chia s·∫ª n·ªói trƒÉn tr·ªü **l√†m sao ƒë·ªÉ l·∫•y ƒë∆∞·ª£c t·ª∑ gi√° c·ªßa 3 ng√¢n h√†ng Vi·ªát Nam trong 5 th√°ng g·∫ßn nh·∫•t**.
L√† m·ªôt ng∆∞·ªùi em trai c√≥ hi·∫øu th√¨ kh√¥ng th·ªÉ kh√¥ng gi√∫p ch·ªã g√°i m√¨nh ƒë∆∞·ª£c. ƒê·∫•y l√† ng∆∞·ªùi b√¨nh th∆∞·ªùng s·∫Ω nghƒ© th·∫ø, nh∆∞ng t√¥i th∆∞∆°ng ch√°u t√¥i nhi·ªÅu h∆°n.
ƒê·ªÉ m·ªói ng√†y nh·ªØng ng∆∞·ªùi ch√°u c√≥ th√™m th·ªùi gian ƒë∆∞·ª£c m·∫π chƒÉm s√≥c v√† d·∫°y d·ªó. T√¥i quy·∫øt ƒë·ªãnh vi·∫øt m·ªôt crawler nh·ªè ƒë·ªÉ gi√∫p ch·ªã t√¥i.

D∆∞·ªõi ƒë√¢y l√† y√™u c·∫ßu t·ª´ m·∫π c·ªßa ch√°u t√¥i:

- L·∫•y t·ª∑ gi√° h·ªëi ƒëo√°i 5 th√°ng g·∫ßn nh·∫•t
- L·∫•y t·ª∑ gi√° c√°c ng√†y ti·∫øp theo sau h√¥m nay
- D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u d∆∞·ªõi d·∫°ng c√≥ th·ªÉ m·ªü ƒë∆∞·ª£c b·∫±ng Excel

Ngo√†i ra c√≥ th√™m 1 y√™u c·∫ßu nho nh·ªè t√¥i t·ª± th√™m v√†o

- **Kh√¥ng t·ªën ti·ªÅn ho·∫∑c t·ªën r·∫•t √≠t** v√¨ t√¥i kh√¥ng ƒë∆∞·ª£c tr·∫£ ti·ªÅn cho vi·ªác n√†y. Ch√°u t√¥i c√≤n qu√° nh·ªè ƒë·ªÉ hi·ªÉu ƒë∆∞·ª£c s·ª± hi sinh l·ªõn lao c·ªßa c·∫≠u n√≥ üòÖ

## Gi·∫£i ph√°p

Sau m·ªôt h·ªìi b·ªëi r·ªëi tr∆∞·ªõc c·∫•u tr√∫c HTML v√† c√°ch truy·ªÅn params c·ªßa ng√¢n h√†ng S, t√¥i quy·∫øt ƒë·ªãnh ch·ªçn c√°ch l√†m ƒë∆°n gi·∫£n:

-> D·ªØ li·ªáu 5 th√°ng ƒë·∫ßu s·∫Ω ƒë∆∞·ª£c crawl tr√™n m√°y c√° nh√¢n s·ª≠ d·ª•ng selenium, d·ªØ li·ªáu c√°c ng√†y ti·∫øp theo s·∫Ω ƒë∆∞·ª£c crawl b·∫±ng lambda function v√¨ kh√¥ng y√™u c·∫ßu t∆∞∆°ng t√°c tr√™n trang web ƒë·ªÉ l·∫•y t·ª∑ gi√° ng√†y hi·ªán t·∫°i.

Vi·ªác ph√°t tri·ªÉn 1 crawler s·ª≠ d·ª•ng headless browser tr√™n lambda s·∫Ω t·ªën th·ªùi gian <small>~~m√† t√¥i th√¨ kh√¥ng ƒë∆∞·ª£c tr·∫£ ti·ªÅn =))~~</small>

ƒê√¢y s·∫Ω l√† gi·∫£i ph√°p cho y√™u c·∫ßu ph√≠a tr√™n:

- Crawler vi·∫øt b·∫±ng python s·ª≠ d·ª•ng BeautifulSoup, requests cho bank M, B, ri√™ng bank S s·∫Ω c√≥ th√™m selenium.
- M·ªôt serverless application s·ª≠ d·ª•ng AWS Lambda ƒë·ªÉ crawl d·ªØ li·ªáu nh·ªØng ng√†y ti·∫øp theo (build v·ªõi [AWS Serverless Application Model](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html))
- D·ªØ li·ªáu crawl ƒë∆∞·ª£c l∆∞u t·∫°i DynamoDB
- API ƒë·ªÉ download csv ƒë∆∞·ª£c t·∫°o t·ª´ DynamoDB, filter theo params l√† ng√†y ƒë·∫ßu v√† ng√†y cu·ªëi

![AWS Always free](/static/images/assets/free-tier.png)

L√Ω do s·ª≠ d·ª•ng DynamoDB l∆∞u d·ªØ li·ªáu ch·ª© kh√¥ng ph·∫£i S3 ƒë·ªÉ l∆∞u CSV file:

- S3 kh√¥ng h·ªó tr·ª£ vi·ªác append v√†o file. N·∫øu s·ª≠ d·ª•ng mu·ªën append s3 v·ªõi Lambda function, ta ph·∫£i download file -> append v√†o file -> xo√° file v√† reupload. Gi·∫£i ph√°p ƒë∆°n gi·∫£n nh∆∞ng t·ªën ti·ªÅn l√† d√πng Kinesis Firehose.
- N·∫øu s·ª≠ d·ª•ng s3, vi·ªác filter d·ªØ li·ªáu theo ng√†y s·∫Ω kh√¥ng ƒë∆°n gi·∫£n b·∫±ng d√πng DynamoDB
- V√¨ n√≥ mi·ªÖn ph√≠ (< 25GB storage)

Diagram ph·ª©c t·∫°p c·ªßa gi·∫£i ph√°p cho y√™u c·∫ßu crawl d·ªØ li·ªáu ƒë∆°n gi·∫£n üòÖ

![Currency crawler diagram final](/static/images/assets/currency-crawler-final.png)

## Tri·ªÉn khai

### SAM local

- [C√†i ƒë·∫∑t SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html)
- T·∫°o project currency-crawler

```shell:shell
 sam init --name currency-crawler --runtime python3.9
```

- Setup [AWS credentials](https://docs.aws.amazon.com/powershell:shell/latest/userguide/pstools-appendix-sign-up.html)

```shell:shell
vi ~/.aws/credentials
```

```yaml:~/.aws/credentials
[vntechies]
aws_access_key_id=******
aws_secret_access_key=******
```

- T·∫°o template cho h·ªá th·ªëng s·ª≠ d·ª•ng SAM

```yaml:template.yaml
AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  currency-crawler

  Sample SAM Template for currency-crawler

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 100

Resources:
  CurrencyCrawlFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: currency/
      Handler: app.crawl
      Runtime: python3.9
      Architectures:
        - x86_64
      Events:
        InvocationLevel:
          Type: Schedule
          Properties:
            Schedule: cron(0 11 ? * MON-FRI *) # All scheduled events use UTC+0 time zone
            DeadLetterConfig:
              Type: SQS
      Policies:
        DynamoDBWritePolicy:
          TableName: !Ref CurrencyTable

  CurrencyGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: currency/
      Handler: app.get_csv
      Runtime: python3.9
      Architectures:
        - x86_64
      Events:
        CurrencyCrawler:
          Type: HttpApi # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            Path: /csv
            Method: get
            ApiId: !Ref CurrencyHTTPApi
      Policies:
        DynamoDBReadPolicy:
          TableName: !Ref CurrencyTable

  CurrencyHTTPApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      CorsConfiguration:
        AllowOrigins:
          - "*"
        AllowHeaders:
          - "Content-Transfer-Encoding"
        AllowMethods:
          - GET

  CurrencyTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      PrimaryKey:
        Name: dt
        Type: String
      #ProvisionedThroughput:
      TableName: "Currency"

Outputs:
  # https://github.com/awslabs/serverless-application-model/blob/master/docs/internals/generated_resources.rst#api
  CurrencyCrawlApi:
    Description: "API Gateway endpoint URL for Prod stage for Hello World function"
    Value: !Sub "https://${CurrencyHTTPApi}.execute-api.${AWS::Region}.amazonaws.com/crawl/"
  CurrencyCrawlFunction:
    Description: "Hello World Lambda Function ARN"
    Value: !GetAtt CurrencyCrawlFunction.Arn
  CurrencyCrawlFunctionIamRole:
    Description: "Implicit IAM Role created for Hello World function"
    Value: !GetAtt CurrencyCrawlFunctionRole.Arn
```

- M·ªôt s·ªë l∆∞u √Ω

  - Lambda function connect ƒë∆∞·ª£c v·ªõi public Internet by default
  - `DynamoDBReadPolicy`, `DynamoDBWritePolicy` assign quy·ªÅn ƒë·ªçc v√† ghi t·ªõi DynamoDB v·ªõi t·ª´ng function
  - `AWS::Serverless::HttpApi` s·ª≠ d·ª•ng HTTP API thay v√¨ REST API v√¨ ch·ªâ c·∫ßn Regional access v√† kh√¥ng c·∫ßn nh·ªØng t√≠nh nƒÉng c·ªßa REST API -> gi·∫£m chi ph√≠
  - `cron(0 11 ? * MON-FRI *)` schedule cron s·ª≠ d·ª•ng m√∫i gi·ªù UTC+0
  - `Content-Transfer-Encoding` c√°c request download file t·ª´ Lambda funtion s·∫Ω c√≥ size limit l√† 6MB v√† c·∫ßn ƒë∆∞·ª£c m√£ ho√° base64 -> c·∫ßn allow header n√†y t·∫°i HTTP API
  - `ProvisionedThroughput` c·ªßa DynamoDB: n·∫øu khai b√°o pricing model s·∫Ω l√† provisioned, n·∫øu ƒë·ªÉ tr·ªëng th√¨ model s·∫Ω l√† on demand

- Vi·∫øt c√°c h√†m crawler cho c√°c banks. N·∫øu b·∫°n quan t√¢m c√≥ th·ªÉ tham kh·∫£o [source code t·∫°i ƒë√¢y](https://github.com/vntechies/002-currency-crawler).

### Test & Validate & Build & Deploy

```shell:shell
# test function b·∫±ng event m·∫´u t·ª´ EventBridge
sam local invoke "CurrencyCrawlFunction" -e events/event.json
# validate SAM template
sam validate --profile vntechies --region ap-southeast-1
# build package
sam build
# deploy
sam deploy --guided --profile vntechies
```

### Chores

- Vi·∫øt script l·∫•y d·ªØ li·ªáu cho 150 ng√†y tr∆∞·ªõc ƒë√≥ (tr·ª´ cu·ªëi tu·∫ßn).
  L·∫•y ƒë·∫°i di·ªán bank S, t√¥i ph·∫£i d√πng headless browser v√¨ c·∫•u tr√∫c h∆°i ph·ª©c t·∫°p ü•≤

```txt:requirements.txt
bs4
pandas
selenium
webdriver_manager
requests
```

```shell:shell
cd crawl_old_data
pip install -r requirements.txt
vi scb.py
```

```python:scb.py
from decimal import Decimal
from time import sleep
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.support.ui import WebDriverWait
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
from datetime import date, datetime, timedelta
from bs4 import BeautifulSoup
from selenium.common.exceptions import TimeoutException
import pandas as pd

import pdb
CURRENCIES = ['USD', 'EUR', 'JPY', 'AUD', 'HKD', 'SGD']


def get_record(requested_date_str, driver):
    driver.find_element(By.CSS_SELECTOR, "#dtpNgayMoney > span > i").click()
    title = driver.find_element(
        By.CSS_SELECTOR, "ul > li > div > div > table > thead> tr > th:nth-child(2)")
    previous_button = driver.find_element(
        By.CSS_SELECTOR, "ul > li > div > div > table > thead> tr > th:nth-child(1)")
    next_button = driver.find_element(
        By.CSS_SELECTOR, "ul > li > div > div > table > thead> tr > th:nth-child(3)")
    current_month = int(title.text.split(' ')[1])
    requested_date = datetime.strptime(requested_date_str, '%d/%m/%Y').date()
    while requested_date.month < current_month:
        previous_button.click()
        current_month = int(title.text.split(' ')[1])
    while requested_date.month > current_month:
        next_button.click()
        current_month = int(title.text.split(' ')[1])
    cal_body = driver.find_element(
        By.CSS_SELECTOR, "div.datepicker-days > table > tbody")
    cal_body.find_element(
        By.XPATH, f"//td[text()='{requested_date.day}']").click()
    sleep(5)
    delay = 3  # seconds
    try:
        WebDriverWait(driver, delay).until(
            EC.presence_of_element_located((By.CSS_SELECTOR, '#bdUSDG7 > table')))
        print("Page is ready!")
    except TimeoutException:
        print("Loading took too much time!")
    table = driver.find_element(By.CSS_SELECTOR, "#bdUSDG7 > table")
    content = table.get_attribute('innerHTML')
    soup = BeautifulSoup(content, features="html.parser")
    items = soup.findAll("tr", {"class": "tr-items"})
    record = {
        "bank": "STB",
        "date": requested_date.strftime("%Y-%m-%d")
    }
    for item in items:
        currency = item.find(
            "td", {"class": "td-cell01"}).contents[1].replace(' ', '')
        if currency in CURRENCIES:
            rate = item.find("td", {"class": "td-cell04"}
                             ).contents[0].replace('.', '').replace(',', '.')
            record[currency] = Decimal(rate)
    return record


end_date = date.today()
current_date = end_date + timedelta(days=-150)
delta = timedelta(days=1)

docs = []
driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()))
driver.get("https://www.**.com.vn/company/Pages/ty-gia.aspx")

while current_date <= end_date:
    if current_date.weekday() > 4:
        print("Skip weekends")
        current_date += delta
        continue
    current_date_str = current_date.strftime("%d/%m/%Y")
    print(f"getting data for {current_date_str}")
    docs.append(get_record(current_date_str, driver))
    current_date_str
    current_date += delta
    sleep(2)
df = pd.DataFrame(docs)
df.to_csv('scb_rates.csv', index=False, header=True)

print("Completed!")
```

- Ch·∫°y script n√†y c√πng c√°c script kh√°c ([source code t·∫°i ƒë√¢y](https://github.com/vntechies/002-currency-crawler/tree/main/crawl_old_data))

```shell:shell
python scb.py
python mbb.py
python bidv.py
```

- V·∫≠y l√† d·ªØ li·ªáu c·ªßa 5 th√°ng tr∆∞·ªõc ƒë√£ xong, vi·ªác c√≤n l·∫°i l√† ƒë·ª£i EventBrigde trigger Lambda function l·∫•y d·ªØ li·ªáu v√† b√† ch·ªã c·ªßa t√¥i c√≥ th·ªÉ download d·ªØ li·ªáu b·∫±ng ƒë·ªãa ch·ªâ m√† t√¥i ƒë√£ g·ª≠i.

## Improvements

<small>
  {' '}
  Th·ª© m√† t√¥i s·∫Ω kh√¥ng l√†m v√¨ nh∆∞ ƒë√£ tr√¨nh b√†y, t√¥i kh√¥ng ƒë∆∞·ª£c tr·∫£ ti·ªÅn cho vi·ªác n√†y üòÇ{' '}
</small>

1. X·ª≠ l√Ω l·ªói cho c√°c HTTP requests t·ªõi c√°c site c·ªßa banks ƒë·ªÅ ph√≤ng tr∆∞·ªùng h·ª£p bank n√†o ƒë√≥ b·∫≠t maintainance mode ho·∫∑c thay ƒë·ªïi giao di·ªán, handle dead letter queue
2. ƒê√°nh index cho b·∫£ng Currency, s·ª≠ d·ª•ng query thay v√¨ scan ƒë·ªÉ gi·∫£m chi ph√≠ (n·∫øu ph√°t sinh), s·ª≠ d·ª•ng DynamoDB update expressions x·ª≠ l√Ω vi·ªác ghi ƒë√® d·ªØ li·ªáu n·∫øu c√≥
3. S·ª≠ d·ª•ng Authentication cho c√°c APIs
4. Headless browser tr√™n Lambda
5. Unit tests v√† integration tests, t·∫°o c√°c m√¥i tr∆∞·ªùng ph√°t tri·ªÉn kh√°c (dev, staging,...)
6. Handle file size limit t·ª´ Lambda (6MB). C≈©ng l√† l·ªùi nh·∫Øn nh·ªß v·ªõi ch·ªã g√°i, **ƒë·ª´ng download d·ªØ li·ªáu > 12 th√°ng.** üôÑ

Nh∆∞ title ƒë√£ n√≥i, gi·∫£i ph√°p n√†y h∆°i c·ªìng k·ªÅnh v√† h∆°i √©p khi s·ª≠ d·ª•ng dao m·ªï tr√¢u, ph∆∞∆°ng √°n t·ªët h∆°n (ƒë∆°n gi·∫£n h∆°n) cho y√™u c·∫ßu n√†y l√† vi·∫øt python scripts r·ªìi ch·∫°y cronjob tr√™n 1 server ho·∫∑c ƒë∆°n gi·∫£n h∆°n l√† ƒë∆∞a script cho ng∆∞·ªùi y√™u c·∫ßu t·ª± ch·∫°y h√†ng ng√†y/tu·∫ßn.
Tuy nhi√™n, b·∫±ng gi·∫£i ph√°p overengineering n√†y m√† m√¨nh c≈©ng bi·∫øt th√™m, catch up l·∫°i m·ªôt s·ªë ki·∫øn th·ª©c li√™n quan t·ªõi serverless application, l√Ω do ch√≠nh l·ªõn h∆°n l√† c√≤n c√≥ c·ªõ ƒë·ªÉ vi·∫øt b√†i v√† th·ªÉ hi·ªán t√¢m huy·∫øt v·ªõi ng∆∞·ªùi ch·ªã g√°i :)

Cu·ªëi c√πng th√¨, c√°c b·∫°n h√£y c√¢n nh·∫Øc t·ªõi vi·ªác [automate nh·ªØng task h·∫±ng ng√†y b·∫±ng python](https://automatetheboringstuff.com/) ho·∫∑c s·ª≠ d·ª•ng serverless application cho cronjob nh√© üò¨

## References

- [Troubleshoot networking issues in Lambda](https://docs.aws.amazon.com/lambda/latest/dg/troubleshooting-networking.html)
- [Handling binary data using Amazon API Gateway HTTP APIs](https://aws.amazon.com/blogs/compute/handling-binary-data-using-amazon-api-gateway-http-apis/)
- [Choosing between REST APIs and HTTP APIs](https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-vs-rest.html)
