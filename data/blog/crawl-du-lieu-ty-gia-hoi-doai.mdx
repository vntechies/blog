---
title: Crawl dá»¯ liá»‡u tá»· giÃ¡ há»‘i Ä‘oÃ¡i vá»›i AWS Lambda vÃ  DynamoDB (Over engineer version)
date: '2022-08-12'
tags:
  [
    'aws',
    'crawler',
    's3',
    'lambda',
    'automation',
    'eventbridge',
    'serverless',
    'python',
    'selenium',
  ]
draft: false
authors: ['mau']
images: ['/static/images/ogps/currency-crawler.png']
summary: 'Crawler Ä‘Æ¡n giáº£n phá»¥c vá»¥ cho viá»‡c láº¥y dá»¯ liá»‡u tá»· giÃ¡ há»‘i Ä‘oÃ¡i cá»§a cÃ¡c ngÃ¢n hÃ ng Viá»‡t Nam'
---

![Currency Crawler](/static/images/ogps/currency-crawler.png)

<TOCInline toc={props.toc} asDisclosure />

## TL;DR

Giáº£i phÃ¡p Ä‘Æ¡n giáº£n cho yÃªu cáº§u crawl dá»¯ liá»‡u Ä‘Æ¡n giáº£n ğŸ˜…

## YÃªu cáº§u

Má»™t ngÃ y Ä‘áº¹p trá»i, bÃ  chá»‹ gÃ¡i yÃªu dáº¥u cá»§a tÃ´i cÃ³ chia sáº» ná»—i trÄƒn trá»Ÿ **lÃ m sao Ä‘á»ƒ láº¥y Ä‘Æ°á»£c tá»· giÃ¡ cá»§a 3 ngÃ¢n hÃ ng Viá»‡t Nam trong 5 thÃ¡ng gáº§n nháº¥t**.
LÃ  má»™t ngÆ°á»i em trai cÃ³ hiáº¿u thÃ¬ khÃ´ng thá»ƒ khÃ´ng giÃºp chá»‹ gÃ¡i mÃ¬nh Ä‘Æ°á»£c. Äáº¥y lÃ  ngÆ°á»i bÃ¬nh thÆ°á»ng sáº½ nghÄ© tháº¿, nhÆ°ng tÃ´i thÆ°Æ¡ng chÃ¡u tÃ´i nhiá»u hÆ¡n.
Äá»ƒ má»—i ngÃ y nhá»¯ng ngÆ°á»i chÃ¡u cÃ³ thÃªm thá»i gian Ä‘Æ°á»£c máº¹ chÄƒm sÃ³c vÃ  dáº¡y dá»—. TÃ´i quyáº¿t Ä‘á»‹nh viáº¿t má»™t crawler nhá» Ä‘á»ƒ giÃºp chá»‹ tÃ´i.

DÆ°á»›i Ä‘Ã¢y lÃ  yÃªu cáº§u tá»« máº¹ cá»§a chÃ¡u tÃ´i:

- Láº¥y tá»· giÃ¡ há»‘i Ä‘oÃ¡i 5 thÃ¡ng gáº§n nháº¥t
- Láº¥y tá»· giÃ¡ cÃ¡c ngÃ y tiáº¿p theo sau hÃ´m nay
- Dá»¯ liá»‡u Ä‘Æ°á»£c lÆ°u dÆ°á»›i dáº¡ng cÃ³ thá»ƒ má»Ÿ Ä‘Æ°á»£c báº±ng Excel

NgoÃ i ra cÃ³ thÃªm 1 yÃªu cáº§u nho nhá» tÃ´i tá»± thÃªm vÃ o

- **KhÃ´ng tá»‘n tiá»n hoáº·c tá»‘n ráº¥t Ã­t** vÃ¬ tÃ´i khÃ´ng Ä‘Æ°á»£c tráº£ tiá»n cho viá»‡c nÃ y. ChÃ¡u tÃ´i cÃ²n quÃ¡ nhá» Ä‘á»ƒ hiá»ƒu Ä‘Æ°á»£c sá»± hi sinh lá»›n lao cá»§a cáº­u nÃ³ ğŸ˜…

## Giáº£i phÃ¡p

Sau má»™t há»“i bá»‘i rá»‘i trÆ°á»›c cáº¥u trÃºc HTML vÃ  cÃ¡ch truyá»n params cá»§a ngÃ¢n hÃ ng S, tÃ´i quyáº¿t Ä‘á»‹nh chá»n cÃ¡ch lÃ m Ä‘Æ¡n giáº£n:

-> Dá»¯ liá»‡u 5 thÃ¡ng Ä‘áº§u sáº½ Ä‘Æ°á»£c crawl trÃªn mÃ¡y cÃ¡ nhÃ¢n sá»­ dá»¥ng selenium, dá»¯ liá»‡u cÃ¡c ngÃ y tiáº¿p theo sáº½ Ä‘Æ°á»£c crawl báº±ng lambda function vÃ¬ khÃ´ng yÃªu cáº§u tÆ°Æ¡ng tÃ¡c trÃªn trang web Ä‘á»ƒ láº¥y tá»· giÃ¡ ngÃ y hiá»‡n táº¡i.

Viá»‡c phÃ¡t triá»ƒn 1 crawler sá»­ dá»¥ng headless browser trÃªn lambda sáº½ tá»‘n thá»i gian <small>~~mÃ  tÃ´i thÃ¬ khÃ´ng Ä‘Æ°á»£c tráº£ tiá»n =))~~</small>

ÄÃ¢y sáº½ lÃ  giáº£i phÃ¡p cho yÃªu cáº§u phÃ­a trÃªn:

- Crawler viáº¿t báº±ng python sá»­ dá»¥ng BeautifulSoup, requests cho bank M, B, riÃªng bank S sáº½ cÃ³ thÃªm selenium.
- Má»™t serverless application sá»­ dá»¥ng AWS Lambda Ä‘á»ƒ crawl dá»¯ liá»‡u nhá»¯ng ngÃ y tiáº¿p theo (build vá»›i [AWS Serverless Application Model](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html))
- Dá»¯ liá»‡u crawl Ä‘Æ°á»£c lÆ°u táº¡i DynamoDB
- API Ä‘á»ƒ download csv Ä‘Æ°á»£c táº¡o tá»« DynamoDB, filter theo params lÃ  ngÃ y Ä‘áº§u vÃ  ngÃ y cuá»‘i

![AWS Always free](/static/images/assets/free-tier.png)

LÃ½ do sá»­ dá»¥ng DynamoDB lÆ°u dá»¯ liá»‡u chá»© khÃ´ng pháº£i S3 Ä‘á»ƒ lÆ°u CSV file:

- S3 khÃ´ng há»— trá»£ viá»‡c append vÃ o file. Náº¿u sá»­ dá»¥ng muá»‘n append s3 vá»›i Lambda function, ta pháº£i download file -> append vÃ o file -> xoÃ¡ file vÃ  reupload. Giáº£i phÃ¡p Ä‘Æ¡n giáº£n nhÆ°ng tá»‘n tiá»n lÃ  dÃ¹ng Kinesis Firehose.
- Náº¿u sá»­ dá»¥ng s3, viá»‡c filter dá»¯ liá»‡u theo ngÃ y sáº½ khÃ´ng Ä‘Æ¡n giáº£n báº±ng dÃ¹ng DynamoDB
- VÃ¬ nÃ³ miá»…n phÃ­ (< 25GB storage)

Diagram phá»©c táº¡p cá»§a giáº£i phÃ¡p cho yÃªu cáº§u crawl dá»¯ liá»‡u Ä‘Æ¡n giáº£n ğŸ˜…

![Currency crawler diagram final](/static/images/assets/currency-crawler-final.png)

## Triá»ƒn khai

### SAM local

- [CÃ i Ä‘áº·t SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html)
- Táº¡o project currency-crawler

```shell:shell
 sam init --name currency-crawler --runtime python3.9
```

- Setup [AWS credentials](https://docs.aws.amazon.com/powershell:shell/latest/userguide/pstools-appendix-sign-up.html)

```shell:shell
vi ~/.aws/credentials
```

```yaml:~/.aws/credentials
[vntechies]
aws_access_key_id=******
aws_secret_access_key=******
```

- Táº¡o template cho há»‡ thá»‘ng sá»­ dá»¥ng SAM

```yaml:template.yaml
AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  currency-crawler

  Sample SAM Template for currency-crawler

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 100

Resources:
  CurrencyCrawlFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: currency/
      Handler: app.crawl
      Runtime: python3.9
      Architectures:
        - x86_64
      Events:
        InvocationLevel:
          Type: Schedule
          Properties:
            Schedule: cron(0 11 ? * MON-FRI *) # All scheduled events use UTC+0 time zone
            DeadLetterConfig:
              Type: SQS
      Policies:
        DynamoDBWritePolicy:
          TableName: !Ref CurrencyTable

  CurrencyGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: currency/
      Handler: app.get_csv
      Runtime: python3.9
      Architectures:
        - x86_64
      Events:
        CurrencyCrawler:
          Type: HttpApi # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            Path: /csv
            Method: get
            ApiId: !Ref CurrencyHTTPApi
      Policies:
        DynamoDBReadPolicy:
          TableName: !Ref CurrencyTable

  CurrencyHTTPApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      CorsConfiguration:
        AllowOrigins:
          - "*"
        AllowHeaders:
          - "Content-Transfer-Encoding"
        AllowMethods:
          - GET

  CurrencyTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      PrimaryKey:
        Name: dt
        Type: String
      #ProvisionedThroughput:
      TableName: "Currency"

Outputs:
  # https://github.com/awslabs/serverless-application-model/blob/master/docs/internals/generated_resources.rst#api
  CurrencyCrawlApi:
    Description: "API Gateway endpoint URL for Prod stage for Hello World function"
    Value: !Sub "https://${CurrencyHTTPApi}.execute-api.${AWS::Region}.amazonaws.com/crawl/"
  CurrencyCrawlFunction:
    Description: "Hello World Lambda Function ARN"
    Value: !GetAtt CurrencyCrawlFunction.Arn
  CurrencyCrawlFunctionIamRole:
    Description: "Implicit IAM Role created for Hello World function"
    Value: !GetAtt CurrencyCrawlFunctionRole.Arn
```

- Má»™t sá»‘ lÆ°u Ã½

  - Lambda function connect Ä‘Æ°á»£c vá»›i public Internet by default
  - `DynamoDBReadPolicy`, `DynamoDBWritePolicy` assign quyá»n Ä‘á»c vÃ  ghi tá»›i DynamoDB vá»›i tá»«ng function
  - `AWS::Serverless::HttpApi` sá»­ dá»¥ng HTTP API thay vÃ¬ REST API vÃ¬ chá»‰ cáº§n Regional access vÃ  khÃ´ng cáº§n nhá»¯ng tÃ­nh nÄƒng cá»§a REST API -> giáº£m chi phÃ­
  - `cron(0 11 ? * MON-FRI *)` schedule cron sá»­ dá»¥ng mÃºi giá» UTC+0
  - `Content-Transfer-Encoding` cÃ¡c request download file tá»« Lambda funtion sáº½ cÃ³ size limit lÃ  6MB vÃ  cáº§n Ä‘Æ°á»£c mÃ£ hoÃ¡ base64 -> cáº§n allow header nÃ y táº¡i HTTP API
  - `ProvisionedThroughput` cá»§a DynamoDB: náº¿u khai bÃ¡o pricing model sáº½ lÃ  provisioned, náº¿u Ä‘á»ƒ trá»‘ng thÃ¬ model sáº½ lÃ  on demand

- Viáº¿t cÃ¡c hÃ m crawler cho cÃ¡c banks. Náº¿u báº¡n quan tÃ¢m cÃ³ thá»ƒ tham kháº£o [source code táº¡i Ä‘Ã¢y](https://github.com/vntechies/002-currency-crawler).

### Test & Validate & Build & Deploy

```shell:shell
# test function báº±ng event máº«u tá»« EventBridge
sam local invoke "CurrencyCrawlFunction" -e events/event.json
# validate SAM template
sam validate --profile vntechies --region ap-southeast-1
# build package
sam build
# deploy
sam deploy --guided --profile vntechies
```

### Chores

- Viáº¿t script láº¥y dá»¯ liá»‡u cho 150 ngÃ y trÆ°á»›c Ä‘Ã³ (trá»« cuá»‘i tuáº§n).
  Láº¥y Ä‘áº¡i diá»‡n bank S, tÃ´i pháº£i dÃ¹ng headless browser vÃ¬ cáº¥u trÃºc hÆ¡i phá»©c táº¡p ğŸ¥²

```txt:requirements.txt
bs4
pandas
selenium
webdriver_manager
requests
```

```shell:shell
cd crawl_old_data
pip install -r requirements.txt
vi scb.py
```

```python:scb.py
from decimal import Decimal
from time import sleep
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.support.ui import WebDriverWait
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
from datetime import date, datetime, timedelta
from bs4 import BeautifulSoup
from selenium.common.exceptions import TimeoutException
import pandas as pd

import pdb
CURRENCIES = ['USD', 'EUR', 'JPY', 'AUD', 'HKD', 'SGD']


def get_record(requested_date_str, driver):
    driver.find_element(By.CSS_SELECTOR, "#dtpNgayMoney > span > i").click()
    title = driver.find_element(
        By.CSS_SELECTOR, "ul > li > div > div > table > thead> tr > th:nth-child(2)")
    previous_button = driver.find_element(
        By.CSS_SELECTOR, "ul > li > div > div > table > thead> tr > th:nth-child(1)")
    next_button = driver.find_element(
        By.CSS_SELECTOR, "ul > li > div > div > table > thead> tr > th:nth-child(3)")
    current_month = int(title.text.split(' ')[1])
    requested_date = datetime.strptime(requested_date_str, '%d/%m/%Y').date()
    while requested_date.month < current_month:
        previous_button.click()
        current_month = int(title.text.split(' ')[1])
    while requested_date.month > current_month:
        next_button.click()
        current_month = int(title.text.split(' ')[1])
    cal_body = driver.find_element(
        By.CSS_SELECTOR, "div.datepicker-days > table > tbody")
    cal_body.find_element(
        By.XPATH, f"//td[text()='{requested_date.day}']").click()
    sleep(5)
    delay = 3  # seconds
    try:
        WebDriverWait(driver, delay).until(
            EC.presence_of_element_located((By.CSS_SELECTOR, '#bdUSDG7 > table')))
        print("Page is ready!")
    except TimeoutException:
        print("Loading took too much time!")
    table = driver.find_element(By.CSS_SELECTOR, "#bdUSDG7 > table")
    content = table.get_attribute('innerHTML')
    soup = BeautifulSoup(content, features="html.parser")
    items = soup.findAll("tr", {"class": "tr-items"})
    record = {
        "bank": "STB",
        "date": requested_date.strftime("%Y-%m-%d")
    }
    for item in items:
        currency = item.find(
            "td", {"class": "td-cell01"}).contents[1].replace(' ', '')
        if currency in CURRENCIES:
            rate = item.find("td", {"class": "td-cell04"}
                             ).contents[0].replace('.', '').replace(',', '.')
            record[currency] = Decimal(rate)
    return record


end_date = date.today()
current_date = end_date + timedelta(days=-150)
delta = timedelta(days=1)

docs = []
driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()))
driver.get("https://www.**.com.vn/company/Pages/ty-gia.aspx")

while current_date <= end_date:
    if current_date.weekday() > 4:
        print("Skip weekends")
        current_date += delta
        continue
    current_date_str = current_date.strftime("%d/%m/%Y")
    print(f"getting data for {current_date_str}")
    docs.append(get_record(current_date_str, driver))
    current_date_str
    current_date += delta
    sleep(2)
df = pd.DataFrame(docs)
df.to_csv('scb_rates.csv', index=False, header=True)

print("Completed!")
```

- Cháº¡y script nÃ y cÃ¹ng cÃ¡c script khÃ¡c ([source code táº¡i Ä‘Ã¢y](https://github.com/vntechies/002-currency-crawler/tree/main/crawl_old_data))

```shell:shell
python scb.py
python mbb.py
python bidv.py
```

- Dá»¯ liá»‡u cá»§a 5 thÃ¡ng trÆ°á»›c Ä‘Ã£ xong âœ…
- EventBrigde trigger Lambda function láº¥y dá»¯ liá»‡u âœ…

![Crawled in DynamoDB](/static/images/assets/crawled_in_dynamodb.png)

- BÃ  chá»‹ gÃ¡i yÃªu dáº¥u cá»§a tÃ´i download dá»¯ liá»‡u báº±ng Ä‘á»‹a chá»‰ mÃ  tÃ´i Ä‘Ã£ gá»­i ğŸ™ˆ

## Improvements

<small>
  {' '}
  Thá»© mÃ  tÃ´i sáº½ khÃ´ng lÃ m vÃ¬ nhÆ° Ä‘Ã£ trÃ¬nh bÃ y, tÃ´i khÃ´ng Ä‘Æ°á»£c tráº£ tiá»n cho viá»‡c nÃ y ğŸ˜‚{' '}
</small>

1. Xá»­ lÃ½ lá»—i cho cÃ¡c HTTP requests tá»›i cÃ¡c site cá»§a banks Ä‘á» phÃ²ng trÆ°á»ng há»£p bank nÃ o Ä‘Ã³ báº­t maintainance mode hoáº·c thay Ä‘á»•i giao diá»‡n, handle dead letter queue
2. ÄÃ¡nh index cho báº£ng Currency, sá»­ dá»¥ng query thay vÃ¬ scan Ä‘á»ƒ giáº£m chi phÃ­ (náº¿u phÃ¡t sinh), sá»­ dá»¥ng DynamoDB update expressions xá»­ lÃ½ viá»‡c ghi Ä‘Ã¨ dá»¯ liá»‡u náº¿u cÃ³
3. Sá»­ dá»¥ng Authentication cho cÃ¡c APIs
4. Headless browser trÃªn Lambda
5. Unit tests vÃ  integration tests, táº¡o cÃ¡c mÃ´i trÆ°á»ng phÃ¡t triá»ƒn khÃ¡c (dev, staging,...)
6. Handle file size limit tá»« Lambda (6MB). CÅ©ng lÃ  lá»i nháº¯n nhá»§ vá»›i chá»‹ gÃ¡i, **Ä‘á»«ng download dá»¯ liá»‡u > 12 thÃ¡ng.** ğŸ™„

NhÆ° title Ä‘Ã£ nÃ³i, giáº£i phÃ¡p nÃ y hÆ¡i cá»“ng ká»nh vÃ  hÆ¡i Ã©p khi sá»­ dá»¥ng dao má»• trÃ¢u, phÆ°Æ¡ng Ã¡n tá»‘t hÆ¡n (Ä‘Æ¡n giáº£n hÆ¡n) cho yÃªu cáº§u nÃ y lÃ  viáº¿t python scripts rá»“i cháº¡y cronjob trÃªn 1 server hoáº·c Ä‘Æ¡n giáº£n hÆ¡n lÃ  Ä‘Æ°a script cho ngÆ°á»i yÃªu cáº§u tá»± cháº¡y hÃ ng ngÃ y/tuáº§n.
Tuy nhiÃªn, báº±ng giáº£i phÃ¡p overengineering nÃ y mÃ  mÃ¬nh cÅ©ng biáº¿t thÃªm, catch up láº¡i má»™t sá»‘ kiáº¿n thá»©c liÃªn quan tá»›i serverless application, lÃ½ do chÃ­nh lá»›n hÆ¡n lÃ  cÃ²n cÃ³ cá»› Ä‘á»ƒ viáº¿t bÃ i vÃ  thá»ƒ hiá»‡n tÃ¢m huyáº¿t vá»›i ngÆ°á»i chá»‹ gÃ¡i :)

Cuá»‘i cÃ¹ng thÃ¬, cÃ¡c báº¡n hÃ£y cÃ¢n nháº¯c tá»›i viá»‡c [automate nhá»¯ng task háº±ng ngÃ y báº±ng python](https://automatetheboringstuff.com/) hoáº·c sá»­ dá»¥ng serverless application cho cronjob nhÃ© ğŸ˜¬

## References

- [Troubleshoot networking issues in Lambda](https://docs.aws.amazon.com/lambda/latest/dg/troubleshooting-networking.html)
- [Handling binary data using Amazon API Gateway HTTP APIs](https://aws.amazon.com/blogs/compute/handling-binary-data-using-amazon-api-gateway-http-apis/)
- [Choosing between REST APIs and HTTP APIs](https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-vs-rest.html)
