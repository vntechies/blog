---
title: 'HTML Reader v·ªõi Golang v√† Lambda function'
date: '2022-08-18'
tags: ['aws', 'lambda', 'golang', 'htmlreader', 'tutorial', 'aws sam', 'serverless']
draft: false
images: ['/static/images/ogps/go-reader.png']
summary: 'HTML Reader s·ª≠ d·ª•ng Golang Lambda function'
---

![Go reader](/static/images/ogps/go-reader.png)

<TOCInline toc={props.toc} asDisclosure />

Repository c·ªßa h∆∞·ªõng d·∫´n n√†y [c√≥ t·∫°i ƒë√¢y](https://github.com/vntechies/004-html-go-reader-lambda)

Trong b√†i vi·∫øt n√†y, ch√∫ng ta s·∫Ω xem x√©t c√°ch tri·ªÉn khai b·∫•t k·ª≥ h√†m Golang n√†o l√™n AWS Lambda m·ªôt c√°ch si√™u d·ªÖ d√†ng.
Ch√∫ng ta c√≥ th·ªÉ ch·∫°y h·∫ßu nh∆∞ t·∫•t c·∫£ c√°c lo·∫°i ·ª©ng d·ª•ng, back end service v·ªõi zero administration (kh√¥ng c·∫ßn qu·∫£n l√Ω)

**V·∫≠y th√¨ ch√∫ng ta s·∫Ω l√†m g√¨?**

![Macos reader](/static/images/assets/macosreader.png)

Ch√∫ng ta s·∫Ω ph√°t tri·ªÉn m·ªôt html reader t∆∞∆°ng t·ª± v·ªõi reader mode tr√™n c√°c tr√¨nh duy·ªát web hi·ªán t·∫°i.
~~Ch·ªçn ·∫£nh h∆°i cay nh√© √¥ng b·∫°n~~ ü•≤

## Thi·∫øt k·∫ø

H·ªá th·ªëng v·ªõi y√™u c·∫ßu ƒë∆°n gi·∫£n n√™n ch√∫ng ta c≈©ng s·∫Ω c√≥ diagram ƒë∆°n gi·∫£n.
Flow:

1. Ng∆∞·ªùi d√πng truy c·∫≠p v√†o html reader v·ªõi params url l√† ƒë·ªãa ch·ªâ c·ªßa trang mu·ªën ƒë·ªçc
2. Lambda function s·∫Ω get html code, parse v√† format l·∫°i n·ªôi dung ch√≠nh b·∫±ng th∆∞ vi·ªán go-readability[^1]
3. Tr·∫£ HTML n·ªôi dung ch√≠nh ƒë∆∞·ª£c x·ª≠ l√Ω t·∫°i Lambda fucntion

![Go reader Diagram](/static/images/assets/goreader-diagram.png)

## Tri·ªÉn khai

### SAM local

- [C√†i ƒë·∫∑t SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html)
- T·∫°o project go-reader

```shell:shell
sam init --name go-reader --runtime go1.x
```

- C√†i ƒë·∫∑t [AWS credentials](https://docs.aws.amazon.com/powershell:shell/latest/userguide/pstools-appendix-sign-up.html)

```shell:shell
vi ~/.aws/credentials
```

```yaml:~/.aws/credentials
[vntechies]
aws_access_key_id=******
aws_secret_access_key=******
```

- T·∫°o template cho h·ªá th·ªëng s·ª≠ d·ª•ng SAM

```yaml:template.yaml
AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  go-reader

  Sample SAM Template for go-reader

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 5

Resources:
  GoReaderFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: go-reader/
      Handler: handler
      Runtime: go1.x
      Architectures:
        - x86_64
      Events:
        CatchAll:
          Type: HttpApi # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            Path: /
            Method: GET
            ApiId: !Ref GoReaderHTTPApi

  GoReaderHTTPApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      CorsConfiguration:
        AllowOrigins:
          - "*"
        AllowHeaders:
          - "Content-Type"
          - "Access-Control-Allow-Origin"
          - "Access-Control-Allow-Headers"
        AllowMethods:
          - GET
          - OPTIONS

Outputs:
  # https://github.com/awslabs/serverless-application-model/blob/master/docs/internals/generated_resources.rst#api
  GoReaderAPI:
    Description: "API Gateway endpoint URL for Prod environment for First Function"
    Value: !Sub "https://${GoReaderHTTPApi}.execute-api.${AWS::Region}.amazonaws.com/"
  GoReaderFunction:
    Description: "First Lambda Function ARN"
    Value: !GetAtt GoReaderFunction.Arn
  GoReaderFunctionIamRole:
    Description: "Implicit IAM Role created for Hello World function"
    Value: !GetAtt GoReaderFunction.Arn
```

- M·ªôt s·ªë l∆∞u √Ω

  - Lambda function connect ƒë∆∞·ª£c v·ªõi public Internet by default
  - `AWS::Serverless::HttpApi` s·ª≠ d·ª•ng HTTP API thay v√¨ REST API v√¨ ch·ªâ c·∫ßn Regional access v√† kh√¥ng c·∫ßn nh·ªØng t√≠nh nƒÉng c·ªßa REST API -> gi·∫£m chi ph√≠
  - AllowHeaders
    - `Content-Type` lambda function s·∫Ω serve html code v√† tr·∫£ v·ªÅ cho ng∆∞·ªùi d√πng th√¥ng qua API gateway, API Gateway c·∫ßn ph·∫£i truy·ªÅn headers n√†y t·ªõi user,
      n·∫øu kh√¥ng browser s·∫Ω hi·ªÉn th·ªã response d∆∞·ªõi d·∫°ng text thay v√¨ html code.

### H√†m Lambda cho GoReader

- Sau khi l·∫•y ƒë∆∞·ª£c n·ªôi dung ch√≠nh c·ªßa trang web qua url ng∆∞·ªùi d√πng cung c·∫•p, ch√∫ng ta s·∫Ω format l·∫°i s·ª≠ d·ª•ng th∆∞ vi·ªán bamboo css[^2]

```go:go-reader/main.go
package main

import (
	"errors"
	"time"

	readability "github.com/go-shiori/go-readability"

	"github.com/aws/aws-lambda-go/events"
	"github.com/aws/aws-lambda-go/lambda"
)

var (
	ErrNoURL = errors.New("No URL provided")
)

func handler(request events.APIGatewayProxyRequest) (events.APIGatewayProxyResponse, error) {
	url := request.QueryStringParameters["url"]

	if len(url) <= 0 {
		return events.APIGatewayProxyResponse{}, ErrNoURL
	}

	article, err := readability.FromURL(url, 30*time.Second)

	if err != nil {
		return events.APIGatewayProxyResponse{}, err
	}

	html := "<!DOCTYPE html><html><head><meta charset='utf-8'/><title>GO READER</title><meta name='viewport' content='width=device-width, initial-scale=1'/><link rel='stylesheet' href='https://unpkg.com/bamboo.css'/></head><body><h2 id='title'>" + article.Title + "</h2><h4>" + article.Excerpt + "</h4><p id='output'>" + article.Content + "</p></body></html>"
	return events.APIGatewayProxyResponse{
		StatusCode: 200,
		Headers: map[string]string{
			"Access-Control-Allow-Origin":  "*",
			"Access-Control-Allow-Headers": "origin,Accept,Authorization,Content-Type",
			"Content-Type":                 "text/html; charset=utf-8",
		},
		Body:            html,
		IsBase64Encoded: false,
	}, nil
}

func main() {
	lambda.Start(handler)
}
```

- C√†i ƒë·∫∑t c√°ch th∆∞ vi·ªán c·∫ßn thi·∫øt tr∆∞·ªõc khi ƒë√≥ng build v√† ƒë√≥ng g√≥i h√†m

```shell:shell
cd go-reader
go get github.com/go-shiori/go-readability
```

### Test & Validate & Build & Deploy

```shell:shell
# test function b·∫±ng event m·∫´u t·ª´ APIGW
sam local invoke "GoReaderFunction" -e events/error_event.json
sam local invoke "GoReaderFunction" -e events/event.json

# validate SAM template
sam validate --profile vntechies --region ap-southeast-1

# build package
sam build

# deploy
sam deploy --guided --profile vntechies
```

## S·∫£n ph·∫©m

![Reader compare](/static/images/assets/readerscompare.png)

**K·∫øt lu·∫≠n:** Nh∆∞ 2 gi·ªçt n∆∞·ªõc ü§£

V·ªõi vi·ªác support nhi·ªÅu ng√¥n ng·ªØ v√† c√≥ th·ªÉ nhanh ch√≥ng, d·ªÖ d√†ng tri·ªÉn khai m·ªôt d·ªãch v·ª• m·ªõi,
Lambda x·ª©ng ƒë√°ng l√† m·ªôt ch·ªçn l·ª±a ti·ªÅm nƒÉng cho c√°c stack c√¥ng ngh·ªá ph√°t tri·ªÉn v·ªõi Golang.

[^1]: https://github.com/go-shiori/go-readability
[^2]: https://github.com/rilwis/bamboo
