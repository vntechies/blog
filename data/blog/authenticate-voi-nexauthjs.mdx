---
title: Authenticate vá»›i NextAuth.js
date: '2022-08-15'
tags: ['facebook', 'nextjs', 'tutorial', 'web']
draft: false
authors: ['mau']
images: ['/static/images/ogps/nextauth.png']
summary: 'Authenticate cho á»©ng dá»¥ng Next.js vá»›i NextAuth.js sá»­ dá»¥ng Facebook & Github lÃ m OAuth provider'
---

<TOCInline toc={props.toc} asDisclosure />

Repository cá»§a hÆ°á»›ng dáº«n nÃ y [cÃ³ táº¡i Ä‘Ã¢y](https://github.com/vntechies/003-authenticate-with-nextauthjs)

## Táº¡o github app

- Táº¡o Github App [táº¡i Ä‘Ã¢y](https://github.com/settings/apps)

![Create github app](/static/images/assets/github-create.png)

- Generate client secret cho app

![get github credentials](/static/images/assets/github-app.png)

## Táº¡o facebook app

- Táº¡o Facebook App [táº¡i Ä‘Ã¢y](https://developers.facebook.com/apps/create/)
- Enable tÃ­nh nÄƒng Facebook Login
- Config callback URL vÃ  cÃ¡c cÃ i Ä‘áº·t cÆ¡ báº£n cho facebook app

![get facebook credentials](/static/images/assets/facebook-app.png)

## NextApp vÃ  NextAuth.js

```shell:shell
# Táº¡o Next.js app má»›i
yarn create next-app 003-authenticate-with-nextauthjs --typescript

#CÃ i Ä‘áº·t next-auth
yarn add next-auth

# Táº¡o file [...nextauth].ts
mkdir pages/api/auth
vi pages/api/auth/\[...nextauth\].js
```

- Config file

```js:[...nextauth].ts
import NextAuth from 'next-auth'
import GitHubProvider from 'next-auth/providers/github'
import FacebookProvider from 'next-auth/providers/facebook'

export default NextAuth({
  providers: [
    GitHubProvider({
      clientId: process.env.GITHUB_ID,
      clientSecret: process.env.GITHUB_SECRET,
    }),
    FacebookProvider({
      clientId: process.env.FACEBOOK_CLIENT_ID,
      clientSecret: process.env.FACEBOOK_CLIENT_SECRET,
    }),
  ],
})
```

- Config cÃ¡c biáº¿n mÃ´i trÆ°á»ng

```env:.env.local
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=secret-string
GITHUB_ID=***
GITHUB_SECRET=***
FACEBOOK_CLIENT_ID=***
FACEBOOK_CLIENT_SECRET=***
```

**Náº¿u khÃ´ng khai bÃ¡o NEXTAUTH_URL thÃ¬ sáº½ gáº·p lá»—i [CLIENT_FETCH_ERROR](https://next-auth.js.org/errors#client_fetch_error) khi deploy lÃªn production hoáº·c staging**

- Allow domain cá»§a facebook vÃ  github Ä‘á»ƒ hiá»ƒn thá»‹ avatar cá»§a ngÆ°á»i dÃ¹ng

```js:next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  swcMinify: true,
  images: {
    domains: ['platform-lookaside.fbsbx.com', 'avatars.githubusercontent.com'],
  },
}

module.exports = nextConfig
```

```js:pages/_app.js
import '../styles/globals.css';
import { SessionProvider } from 'next-auth/react';

import type { AppProps } from 'next/app';

const MyApp = ({ Component, pageProps: { session, ...pageProps } }: AppProps) => {
  return (
    <SessionProvider session={pageProps.session} refetchInterval={5 * 60}>
      <Component {...pageProps} />
    </SessionProvider>
  );
};

export default MyApp;
```

- Sá»­a láº¡i trang index.js

```js:pages/index.js
import { NextPage } from "next";
import { useSession, signIn, signOut } from "next-auth/react";
import Image from "next/image";

import type React from 'react';

const Home: NextPage = () => {
  const { data: session, status } = useSession();

  if (status === 'loading') {
    return null;
  }

  if (session) {
    return (
      <>
        <Image
          src={session?.user?.image}
          alt="avatar"
          width="25px"
          height="25px"
          className="h-48 w-48 rounded-full"
        /><br />
        Signed in as {session?.user?.email} <br />
        <button onClick={() => signOut()}>Sign Out</button>
      </>
    );
  }

  return (
    <>
      Not signed in <br />
      <button onClick={() => signIn()}>Sign in</button>
    </>
  )
}

export default Home;
```

## Demo

![NextAuthDemo](/static/images/assets/next-auth-demo.png)

## Nháº­t xÃ©t

- NextAuth hoáº¡t Ä‘á»™ng tá»‘t vá»›i basic user info scope cá»§a Facebook, Github vÃ  hiá»‡n táº¡i support kha khÃ¡ providers[^1]
- Implement nhanh tuy document cÃ³ hÆ¡i khÃ´ng Ä‘áº§y Ä‘á»§.
- CÃ¡c trang Ä‘Äƒng nháº­p, Ä‘Äƒng xuáº¥t,... cÃ³ thá»ƒ Ä‘Æ°á»£c tuá»³ biáº¿n táº¡i routes `pages/auth/signin.js`, tham kháº£o thÃªm táº¡i document nÃ y[^2]
- NextAuth chÆ°a há»— trá»£ viá»‡c xá»­ lÃ½ refresh token cho cÃ¡c OAuth provider nÃªn ngÆ°á»i dÃ¹ng sáº½ sáº½ pháº£i Ä‘Äƒng nháº­p láº¡i sau khi token háº¿t háº¡n.
  Tuy nhiÃªn, cÃ³ thá»ƒ sá»­ dá»¥ng NextAuth callback dá»ƒ implement logic xá»­ lÃ½ cho pháº§n nÃ y, tham kháº£o document nÃ y[^3]

[^1]: [Providers Overview](https://next-auth.js.org/providers/)
[^2]: [Configuration Pages](https://next-auth.js.org/configuration/pages)
[^3]: [Refresh Token Rotation](https://next-auth.js.org/tutorials/refresh-token-rotation)

## VNTechies Dev Blog

Kho tÃ i nguyÃªn mÃ£ nguá»“n má»Ÿ vá»›i sá»© má»‡nh Ä‘Ã o táº¡o kiáº¿n thá»©c, Ä‘á»‹nh hÆ°á»›ng nghá» nghiá»‡p cho cá»™ng Ä‘á»“ng Cloud â˜ï¸ DevOps ğŸš€

[![Facebook page](/static/images/default-ogp.png)](https://www.facebook.com/vntechies)

Tham gia group [VNTechies - Cloud â˜ï¸ / DevOps ğŸš€](https://www.facebook.com/groups/acevntechies) náº¿u báº¡n muá»‘n giao lÆ°u vá»›i cá»™ng Ä‘á»“ng vÃ  cáº­p nháº­t cÃ¡c thÃ´ng tin má»›i nháº¥t vá» Cloud vÃ  DevOps.

- Website: https://vntechies.dev
- Github repository: https://github.com/vntechies
- Facebook page: https://facebook.com/vntechies

[![Discord banner](https://images.viblo.asia/c8c4a473-c08d-45a3-be57-821781c1c256.png)](https://discord.com/invite/k2uDgd7NZ4)

Anh chá»‹ em hÃ£y follow/á»§ng há»™ VNTechies Ä‘á»ƒ cáº­p nháº­t nhá»¯ng thÃ´ng tin má»›i nháº¥t vá» Cloud vÃ  DevOps nhÃ©!
