---
title: TÃ¡c vá»¥ Fargate Ä‘Æ°á»£c láº­p lá»‹ch - Scheduled Fargate Tasks vá»›i AWS CDK
date: '2022-11-11'
tags: ['aws', 'aws cdk', 'devops', 'fargate', 'ecs']
draft: false
images: ['/static/images/ogps/aws_scheduled_fargate_task.png']
summary: 'BÃ i viáº¿t nÃ y sáº½ giáº£i thÃ­ch cÃ¡c bÆ°á»›c cáº§n thiáº¿t Ä‘á»ƒ triá»ƒn khai má»™t tÃ¡c vá»¥ Fargate Ä‘Æ°á»£c láº­p lá»‹ch (Scheduled Fargate Tasks) báº±ng AWS CDK'
index: 6
---

## TL;DR Talk is cheap. Show me the code.

Báº¡n cÃ³ thá»ƒ tham kháº£o mÃ£ nguá»“n táº¡i [Github repository nÃ y](https://github.com/vntechies/011-aws-cdk-scheduled-fargate-task)

<TOCInline toc={props.toc} asDisclosure />

## Táº¡o AWS VPC

_Trong bÃ i viáº¿t nÃ y, Scheduled Fargate Task sáº½ Ä‘Æ°á»£c dá»‹ch lÃ  **tÃ¡c vá»¥ Fargate Ä‘Æ°á»£c láº­p lá»‹ch**, náº¿u báº¡n Ä‘á»c cÃ³ cÃ¡ch dá»‹ch nÃ o tá»‘t hÆ¡n, xin vui lÃ²ng Ä‘á»ƒ láº¡i comment á»Ÿ bÃªn dÆ°á»›i ğŸ˜_

Äá»ƒ sá»­ dá»¥ng cÃ¡c tÃ¡c vá»¥ Fargate Ä‘Æ°á»£c láº­p lá»‹ch, trÆ°á»›c tiÃªn, báº¡n cáº§n thiáº¿t láº­p má»™t Virtual Private Cloud (VPC). VPC lÃ  má»™t máº¡ng áº£o Ä‘Æ°á»£c tÃ¡ch biá»‡t cho phÃ©p báº¡n khá»Ÿi táº¡o vÃ o triá»ƒn khai cÃ¡c tÃ i nguyÃªn AWS cá»§a mÃ¬nh, vÃ­ dá»¥ nhÆ° cÃ¡c tÃ¡c vá»¥ Fargate Ä‘Æ°á»£c láº­p lá»‹ch.

Báº¡n cÃ³ thá»ƒ chá»‰ Ä‘á»‹nh dáº£i Ä‘á»‹a chá»‰ IP cho VPC, thÃªm máº¡ng con (subnet), liÃªn káº¿t nhÃ³m báº£o máº­t (security group)vÃ  Ä‘á»‹nh cáº¥u hÃ¬nh báº£ng Ä‘á»‹nh tuyáº¿n (route tables). Äá»‘i vá»›i bÃ i viáº¿t nÃ y, chÃºng ta sáº½ táº¡o má»™t VPC vá»›i 9 máº¡ng con Ä‘Æ°á»£c chia trÃªn 3 AZs báº±ng AWS CDK.

DÆ°á»›i Ä‘Ã¢y lÃ  má»™t vÃ­ dá»¥ vá» cÃ¡ch táº¡o VPC:

```python:aws_cdk_scheduled_fargate_task_stack.py
# Táº¡o VPC vá»›i 9 subnets trÃªn 3 AZs
my_vpc = ec2.Vpc(
    self,
    "myvpc",
    cidr="172.31.0.0/16",
    max_azs=3,
    nat_gateways=1,
    subnet_configuration=[
        ec2.SubnetConfiguration(
            cidr_mask=20, name="public", subnet_type=ec2.SubnetType.PUBLIC
        ),
        ec2.SubnetConfiguration(
            cidr_mask=20,
            name="application",
            subnet_type=ec2.SubnetType.PRIVATE_WITH_NAT,
        ),
        ec2.SubnetConfiguration(
            cidr_mask=20,
            name="data",
            subnet_type=ec2.SubnetType.PRIVATE_ISOLATED,
            reserved=True,
        ),
    ],
)
```

## Táº¡o AWS ECS Cluster

Sau khi Ä‘Ã£ triá»ƒn khai cÃ¡c tÃ i nguyÃªn phá»¥ thuá»™c, chÃºng ta cÃ³ thá»ƒ tiáº¿p tá»¥c vá»›i tÃ i nguyÃªn Fargate thá»±c táº¿. Äoáº¡n mÃ£ tiáº¿p theo sá»­ dá»¥ng thÆ° viá»‡n Cáº¥u trÃºc CDK chÃ­nh thá»©c cho Cáº¥u trÃºc ECS cáº¥p cao hÆ¡n (aws-ecs-pattern) Ä‘á»ƒ táº¡o Nhiá»‡m vá»¥ Fargate Ä‘Ã£ lÃªn lá»‹ch:

```python:aws_cdk_scheduled_fargate_task_stack.py
# Táº¡o ECS Cluster
my_cluster = ecs.Cluster(
    self,
    "service-cluster",
    cluster_name="service-cluster",
    container_insights=True,
    vpc=my_vpc,
)
```

## Táº¡o má»™t Scheduled Fargate Task vá»›i AWS CDK

Sau khi Ä‘Ã£ triá»ƒn khai cÃ¡c tÃ i nguyÃªn trÃªn, chÃºng ta cÃ³ thá»ƒ tiáº¿p tá»¥c vá»›i tÃ i nguyÃªn Fargate. Äoáº¡n mÃ£ dÆ°á»›i dÃ¢y sá»­ dá»¥ng [CDK Construct library for higher-level ECS Constructs](https://docs.aws.amazon.com/cdk/api/v1/docs/aws-ecs-patterns-readme.html) (aws-ecs-patterns) Ä‘á»ƒ táº¡o má»™t tÃ¡c vá»¥ Fargate Ä‘Æ°á»£c láº­p lá»‹ch (Scheduled Fargate Task):

```python:aws_cdk_scheduled_fargate_task_stack.py
image = ecs.ContainerImage.from_registry("amazonlinux:2")

ecs_patterns.ScheduledFargateTask(
    self,
    "amazon-linux-echo-task",
    cluster=my_cluster,
    platform_version=ecs.FargatePlatformVersion.LATEST,
    schedule=appscaling.Schedule.expression("rate(1 minute)"),
    scheduled_fargate_task_image_options=ecs_patterns.ScheduledFargateTaskImageOptions(
        image=image,
        memory_limit_mib=1024,
        log_driver=ecs.LogDriver.aws_logs(
            stream_prefix="scheduled-fargate-task",
            log_retention=aws_logs.RetentionDays.ONE_DAY,
        ),
        environment={"APP_NAME": "scheduled-fargate-task"},
        command=["echo", "Xin chÃ o VNTechies!"],
    ),
)
```

- `ecs_patterns.ScheduledFargateTask`, táº¡i Ä‘Ã¢y chÃºng ta khá»Ÿi táº¡o tÃ i nguyÃªn ScheduledFargateTask tá»« thÆ° viá»‡n ecspatterns. ChÃºng ta tham chiáº¿u Ä‘áº¿n cluster Ä‘Ã£ Ä‘Æ°á»£c táº¡o trong pháº§n trÆ°á»›c Ä‘á»ƒ AWS CDK biáº¿t vá»‹ trÃ­ cáº§n Ä‘á»ƒ triá»ƒn khai tÃ¡c vá»¥ Fargate Ä‘Æ°á»£c láº­p lá»‹ch.
- Trong `ScheduleFargateTaskImageOptions`, chÃºng ta Ä‘á»‹nh nghÄ©a cho container, vÃ­ dá»¥ nhÆ° image nÃ o nÃªn Ä‘Æ°á»£c sá»­ dá»¥ng. Táº¡i Ä‘Ã¢y, chÃºng ta sáº½ sá»­ dá»¥ng image `amazonlinux:2` cho container. AWS CDK sáº½ tá»± Ä‘á»™ng láº¥y image Amazon Linux 2 tá»« Amazon ECR vÃ  sá»­ dá»¥ng image Ä‘Ã³ Ä‘á»ƒ triá»ƒn khai tÃ¡c vá»¥ Fargate Ä‘Æ°á»£c láº­p lá»‹ch.
- Báº¡n cÃ³ thá»ƒ chá»‰ Ä‘á»‹nh thá»i gian lÆ°u giá»¯ cho logs cá»§a tÃ¡c vá»¥. Máº·c Ä‘á»‹nh, AWS CDK khÃ´ng cÃ i Ä‘áº·t thá»i gian lÆ°u trá»¯ cho cÃ¡c logs Ä‘Æ°á»£c táº¡o bá»Ÿi cÃ¡c tÃ¡c vá»¥ cá»§a nÃ³. Náº¿u báº¡n muá»‘n cÃ³ cÃ i Ä‘áº·t thá»i gian lÆ°u trá»¯ log cá»§a mÃ¬nh, báº¡n cáº§n Ä‘á»‹nh nghÄ©a vá»›i thuá»™c tÃ­nh `log_retention` trÃªn `log_driver`. GiÃ¡ trá»‹ `aws_logs.RetentionDays.ONE_DAY`, cÃ³ nghÄ©a lÃ  log sáº½ bá»‹ xoÃ¡ sau 1 ngÃ y.
- `command` chá»‰ Ä‘á»‹nh tÃ¡c vá»¥ báº¡n muá»‘n cháº¡y trÃªn container. Sau khi lá»‡nh káº¿t thÃºc, tÃ¡c vá»¥ Fargate (Fargate task) sáº½ ngá»«ng cháº¡y.
- `environment` cho phÃ©p báº¡n import cÃ¡c biáº¿n mÃ´i trÆ°á»ng vÃ o container Ä‘á»ƒ sá»­ dá»¥ng cho tÃ¡c vá»¥ Fargate.
- `memory_limit_mib` Ä‘áº·t giá»›i háº¡n memory sá»­ dá»¥ng hco tÃ¡c vá»¥ Fargate, giÃ¡ trá»‹ máº·c Ä‘á»‹nh lÃ  **512MB**

![TÃ¡c vá»¥ Fargate Ä‘Ã£ Ä‘Æ°á»£c táº¡o](/static/images/assets/aws_cdk_fargate_ecs.png)

![Log Ä‘Æ°á»£c táº¡o bá»Ÿi tÃ¡c vá»¥ Fargate Ä‘Æ°á»£c lÃªn lá»‹ch](/static/images/assets/aws_cdk_fargate_cloudwatch.png)

## Dá»n dáº¹p tÃ i nguyÃªn

XoÃ¡ stack vá»«a Ä‘Æ°á»£c táº¡o bá»Ÿi AWS CDK Ä‘á»ƒ trÃ¡nh phÃ¡t sinh chi phÃ­ khÃ´ng cáº§n thiáº¿t báº¡n nhÃ© ğŸ˜‰

```shell
cdk destroy
```

## Káº¿t luáº­n

Qua hÆ°á»›ng dáº«n nÃ y, chÃºng ta Ä‘Ã£:

- Táº¡o AWS VPC
- Táº¡o má»™t AWS ECS Cluster
- Táº¡o má»™t tÃ¡ch vá»¥ Fargate Ä‘Æ°á»£c láº­p lá»‹ch

Viá»‡c sá»­ dá»¥ng cÃ¡c Construct level cao hÆ¡n hoáº·c cÃ²n Ä‘Æ°á»£c gá»i lÃ  lÃ  cÃ¡c máº«u (patterns), cháº³ng háº¡n nhÆ° cÃ¡c máº«u `ECS` mÃ  chÃºng ta Ä‘Ã£ sá»­ dá»¥ng trong vÃ­ dá»¥ nÃ y giÃºp giáº£m bá»›t ráº¥t nhiá»u cÃ´ng viá»‡c trong viá»‡c táº¡o ra nhiá»u tÃ i nguyÃªn AWS vÃ  cÃ³ cáº£ nhá»¯ng giÃ¡ trá»‹ máº·c Ä‘á»‹nh há»£p lÃ½ Ä‘Æ°á»£c cÃ i Ä‘áº·t sáºµn. CÃ¡c máº«u nhÆ° váº­y cÃ³ thá»ƒ tiáº¿t kiá»‡m thá»i gian phÃ¡t triá»ƒn, nhÆ°ng chÃºng ta sáº½ cÃ³ Ã­t cÃ¡c thiáº¿t láº­p Ä‘Æ°á»£c tuá»³ biáº¿n hÆ¡n.
