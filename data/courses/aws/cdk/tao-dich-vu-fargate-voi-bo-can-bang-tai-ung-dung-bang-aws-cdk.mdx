---
title: Táº¡o dá»‹ch vá»¥ Fargate vá»›i bá»™ cÃ¢n báº±ng táº£i á»©ng dá»¥ng báº±ng AWS CDK
date: '2022-11-11'
tags: ['aws', 'aws cdk', 'devops', 'fargate', 'ecs', 'alb']
draft: false
images: ['/static/images/ogps/aws_alb_fargate.png']
summary: 'BÃ i viáº¿t nÃ y sáº½ giáº£i thÃ­ch cÃ¡c bÆ°á»›c thiáº¿t Ä‘á»ƒ triá»ƒn khai má»™t dá»‹ch vá»¥ Fargate vá»›i bá»™ báº±ng táº£i á»©ng dá»¥ng báº±ng AWS CDK'
index: 7
---

## TL;DR Talk is cheap. Show me the code.

Báº¡n cÃ³ thá»ƒ tham kháº£o mÃ£ nguá»“n táº¡i [Github repository nÃ y](https://github.com/vntechies/011-aws-cdk-scheduled-fargate-task)

<TOCInline toc={props.toc} asDisclosure />

## Táº¡o AWS VPC

TrÆ°á»›c khi cÃ³ thá»ƒ báº¯t Ä‘áº§u xÃ¢y dá»±ng dá»‹ch vá»¥ Fargate cá»§a mÃ¬nh, chÃºng ta cáº§n thiáº¿t láº­p má»™t Virtual Private Cloud (VPC). VPC lÃ  má»™t máº¡ng áº£o Ä‘Æ°á»£c tÃ¡ch biá»‡t cho phÃ©p báº¡n khá»Ÿi táº¡o vÃ o triá»ƒn khai cÃ¡c tÃ i nguyÃªn AWS cá»§a mÃ¬nh, vÃ­ dá»¥ nhÆ° cÃ¡c dá»‹ch vá»¥ Fargate

Báº¡n cÃ³ thá»ƒ chá»‰ Ä‘á»‹nh dáº£i Ä‘á»‹a chá»‰ IP cho VPC, thÃªm máº¡ng con (subnet), liÃªn káº¿t nhÃ³m báº£o máº­t (security group)vÃ  Ä‘á»‹nh cáº¥u hÃ¬nh báº£ng Ä‘á»‹nh tuyáº¿n (route tables). Äá»‘i vá»›i bÃ i viáº¿t nÃ y, chÃºng ta sáº½ táº¡o má»™t VPC vá»›i 9 máº¡ng con Ä‘Æ°á»£c chia trÃªn 3 AZs báº±ng AWS CDK.

Sau Ä‘Ã¢y lÃ  má»™t vÃ­ dá»¥ vá» cÃ¡ch táº¡o VPC.

DÆ°á»›i Ä‘Ã¢y lÃ  má»™t vÃ­ dá»¥ vá» cÃ¡ch táº¡o VPC:

```python:aws_cdk_alb_fargate_service_stack.py
# Táº¡o VPC vá»›i 9 subnets trÃªn 3 AZs
my_vpc = ec2.Vpc(
    self,
    "my_vpc",
    nat_gateways=1,
    cidr="172.31.0.0/16",
    max_azs=3,
    subnet_configuration=[
        ec2.SubnetConfiguration(
            name="public",
            cidr_mask=20,
            subnet_type=ec2.SubnetType.PUBLIC,
        ),
        ec2.SubnetConfiguration(
            name="application",
            cidr_mask=20,
            subnet_type=ec2.SubnetType.PRIVATE_WITH_NAT,
        ),
        ec2.SubnetConfiguration(
            name="data",
            cidr_mask=20,
            subnet_type=ec2.SubnetType.PRIVATE_ISOLATED,
        ),
    ],
)
```

## Táº¡o AWS ECS Cluster

Sau khi Ä‘Ã£ triá»ƒn khai cÃ¡c tÃ i nguyÃªn phá»¥ thuá»™c, chÃºng ta cÃ³ thá»ƒ tiáº¿p tá»¥c vá»›i tÃ i nguyÃªn Fargate thá»±c táº¿. Äoáº¡n mÃ£ tiáº¿p theo sá»­ dá»¥ng thÆ° viá»‡n Cáº¥u trÃºc CDK chÃ­nh thá»©c cho Cáº¥u trÃºc ECS cáº¥p cao hÆ¡n (aws-ecs-pattern) Ä‘á»ƒ táº¡o Nhiá»‡m vá»¥ Fargate Ä‘Ã£ lÃªn lá»‹ch:

```python:aws_cdk_alb_fargate_service_stack.py
# Táº¡o ECS Cluster
cluster = ecs.Cluster(
    self,
    "service-cluster",
    cluster_name="service-cluster",
    container_insights=True,
    vpc=my_vpc,
)
```

## Táº¡o má»™t dá»‹ch vá»¥ Fargate vá»›i bá»™ cÃ¢n báº±ng táº£i á»©ng dá»¥ng (ALB) sá»­ dá»¥ng AWS CDK

Sau khi Ä‘Ã£ triá»ƒn khai cÃ¡c tÃ i nguyÃªn trÃªn, chÃºng ta cÃ³ thá»ƒ tiáº¿p tá»¥c vá»›i tÃ i nguyÃªn Fargate. Äoáº¡n mÃ£ dÆ°á»›i dÃ¢y sá»­ dá»¥ng [CDK Construct library for higher-level ECS Constructs](https://docs.aws.amazon.com/cdk/api/v1/docs/aws-ecs-patterns-readme.html) (aws-ecs-patterns) Ä‘á»ƒ táº¡o má»™t dá»‹ch vá»¥ Fargate vá»›i bá»™ cÃ¢n báº±ng táº£i á»©ng dá»¥ng (ALB):

```python:aws_cdk_alb_fargate_service_stack.py
image = ecs.ContainerImage.from_registry("amazon/amazon-ecs-sample")

ecs_patterns.ApplicationLoadBalancedFargateService(
    self,
    "amazon-ecs-sample",
    circuit_breaker=ecs.DeploymentCircuitBreaker(rollback=True),
    desired_count=1,
    task_image_options=ecs_patterns.ApplicationLoadBalancedTaskImageOptions(
        image=image,
        container_port=80,
        log_driver=ecs.LogDriver.aws_logs(
            stream_prefix="alb-fargate-service",
            log_retention=aws_logs.RetentionDays.ONE_DAY,
        ),
    ),
)
```

- `circuit_breaker` Báº­t tÃ­nh nÄƒng nÃ y cho phÃ©p báº¡n tá»± Ä‘á»™ng rollback láº¡i cÃ¡c tÃ¡c vá»¥ liÃªn quan tá»›i ECS cá»§a mÃ¬nh vá»›i CloudFormation sau khi vÆ°á»£t quÃ¡ giá»›i háº¡n ngÆ°á»¡ng triá»ƒn khai khÃ´ng thÃ nh cÃ´ng (kiá»ƒm tra health check khÃ´ng thÃ nh cÃ´ng).
- `desired_count` sá»‘ láº§n khá»Ÿi táº¡o Ä‘á»‹nh nghÄ©a tÃ¡c vá»¥ (task definition) mong muá»‘n Ä‘á»ƒ tiáº¿p tá»¥c cháº¡y trÃªn dá»‹ch vá»¥.
- `ecs_patterns.ApplicationLoadBalancedFargateService` táº¡i Ä‘Ã¢y dá»‹ch vá»¥ Fargate vÃ  bá»™ cÃ¢n báº±ng táº£i á»©ng dá»¥ng Ä‘Æ°á»£c khá»Ÿi táº¡o sá»­ dá»¥ng thÆ° viá»‡n patterns máº«u cá»§a ECS. ChÃºng ta tham chiáº¿u Ä‘áº¿n cluster Ä‘Ã£ Ä‘Æ°á»£c táº¡o trong pháº§n trÆ°á»›c Ä‘á»ƒ AWS CDK biáº¿t vá»‹ trÃ­ cáº§n Ä‘á»ƒ triá»ƒn khai dá»‹ch vá»¥ Fargate.
- `taskImageOptions` chÃºng ta cáº¥u hÃ¬nh cÃ¡c chi tiáº¿t cho container cháº³ng háº¡n nhÆ° image. Trong bÃ i viáº¿t nÃ y, chÃºng ta sá»­ dá»¥ng hÃ¬nh áº£nh máº«u `amazon/amazon-ecs-sample`, AWS CDK sáº½ tá»± Ä‘á»™ng láº¥y image nÃ y tá»« Amazon ECR vÃ  sá»­ dá»¥ng Ä‘á»ƒ triá»ƒn khai dá»‹ch vá»¥ Fargate.
- `containerPort=80` cho biáº¿t cá»•ng nÃ o sáº½ Ä‘Æ°á»£c expose tá»« dá»‹ch vá»¥ Fargate.
- Báº¡n cÃ³ thá»ƒ chá»‰ Ä‘á»‹nh thá»i gian lÆ°u giá»¯ cho logs cá»§a tÃ¡c vá»¥. Máº·c Ä‘á»‹nh, AWS CDK khÃ´ng cÃ i Ä‘áº·t thá»i gian lÆ°u trá»¯ cho cÃ¡c logs Ä‘Æ°á»£c táº¡o bá»Ÿi cÃ¡c tÃ¡c vá»¥ cá»§a nÃ³. Náº¿u báº¡n muá»‘n cÃ³ cÃ i Ä‘áº·t thá»i gian lÆ°u trá»¯ log cá»§a mÃ¬nh, báº¡n cáº§n Ä‘á»‹nh nghÄ©a vá»›i thuá»™c tÃ­nh `log_retention` trÃªn `log_driver`. GiÃ¡ trá»‹ `aws_logs.RetentionDays.ONE_DAY`, cÃ³ nghÄ©a lÃ  log sáº½ bá»‹ xoÃ¡ sau 1 ngÃ y.

![Dá»‹ch vá»¥ Fargate Ä‘Ã£ Ä‘Æ°á»£c táº¡o](/static/images/assets/awscdk_fargate_alb_cli.png)

![Khi truy cáº­p vÃ o Ä‘á»‹a chá»‰ Ä‘Æ°á»£c cung cáº¥p](/static/images/assets/awscdk_fargate_alb_web.png)

## Dá»n dáº¹p tÃ i nguyÃªn

XoÃ¡ stack vá»«a Ä‘Æ°á»£c táº¡o bá»Ÿi AWS CDK Ä‘á»ƒ trÃ¡nh phÃ¡t sinh chi phÃ­ khÃ´ng cáº§n thiáº¿t báº¡n nhÃ© ğŸ˜‰

```shell
cdk destroy
```

## Káº¿t luáº­n

Qua hÆ°á»›ng dáº«n nÃ y, chÃºng ta Ä‘Ã£:

- Táº¡o AWS VPC
- Táº¡o má»™t AWS ECS Cluster
- Táº¡o má»™t dá»‹ch vá»¥ Fargate vá»›i bá»™ cÃ¢n báº±ng táº£i á»©ng dá»¥ng (ALB)

Viá»‡c sá»­ dá»¥ng cÃ¡c Construct level cao hÆ¡n hoáº·c cÃ²n Ä‘Æ°á»£c gá»i lÃ  lÃ  cÃ¡c máº«u (patterns), cháº³ng háº¡n nhÆ° cÃ¡c máº«u `ECS` mÃ  chÃºng ta Ä‘Ã£ sá»­ dá»¥ng trong vÃ­ dá»¥ nÃ y giÃºp giáº£m bá»›t ráº¥t nhiá»u cÃ´ng viá»‡c trong viá»‡c táº¡o ra nhiá»u tÃ i nguyÃªn AWS vÃ  cÃ³ cáº£ nhá»¯ng giÃ¡ trá»‹ máº·c Ä‘á»‹nh há»£p lÃ½ Ä‘Æ°á»£c cÃ i Ä‘áº·t sáºµn. CÃ¡c máº«u nhÆ° váº­y cÃ³ thá»ƒ tiáº¿t kiá»‡m thá»i gian phÃ¡t triá»ƒn, nhÆ°ng chÃºng ta sáº½ cÃ³ Ã­t cÃ¡c thiáº¿t láº­p Ä‘Æ°á»£c tuá»³ biáº¿n hÆ¡n.
