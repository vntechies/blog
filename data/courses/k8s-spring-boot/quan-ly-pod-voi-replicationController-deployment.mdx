---
title: Quản lý Pod với ReplicationController và Deployment
date: '2022-12-23'
tags: ['api', 'rest-api', 'springboot', 'kubernetes']
series: ['k8s-spring-boot']
draft: false
authors: ['thanhnb']
images: ['/static/images/ogps/k8s-springboot.png']
summary: 'Trong bài này chúng ta sẽ cùng nhau tìm hiểu về cách quản lý Pod trong Kubernetes'
index: 3
---

<TOCInline toc={props.toc} asDisclosure />

## 1. Giới thiệu chung

Ở bài trước thì chúng ta định nghĩa `Pod` bằng YAML file một cách trực tiếp. Khi tạo `Pod` như vậy thì chúng ta sẽ phải tự quản lý, nếu `Pod` vì một lý do nào đó mà bị xóa đi thì chúng ta lại tạo lại `Pod` mới bằng tay. Giờ muốn Kubernetes tự động kiểm tra trạng thái của ứng dụng và tự quản lý các `Pod` thì thay vì tạo `Pod` một cách trực tiếp chúng ta sẽ tạo `Pod` thông qua đối tượng khác của Kubernetes đó là: `ReplicationController` và `Deployment`. Lúc này thì `Pod` sẽ được quản lý một cách tự động. Trong bài này thì chúng ta sẽ tìm hiểu những phần sau:

- Kiểm tra trạng thái của ứng dụng thông qua `liveness probes`.
- Tạo và quản lý `Pod` với `ReplicationController` và `Deployment`.
- Scale ứng dụng bằng cách tăng hoặc giảm số lượng `Pod`.

## 2. Tạo và quản lý Pod với ReplicationController và Deployment

Bài trước chúng ta đã đóng gói containers vào `Pod` và triển khai trên Kubernetes, nhưng `Pod` không scale được (tăng hoặc giảm số lượng `Pod`) và `Pod` cũng khó để có thể update hoặc rollbacks. Để giải quyết vấn đề trên thì trong Kubernetes thì thường sẽ sử dụng các controllers để đóng gói `Pod` vào và quản lý.

### 2.1 Vấn đề khi triển khai Pod một cách trực tiếp

**Self Healing**

Ứng dụng Spring boot mà được đóng gói với `Pod` và triển khai trên Kubernetes, vì một lý do nào đó nó fails hoặc `Pod` của ứng dụng bị xóa đi thì chúng ta mong muốn rằng Kubernetes sẽ tạo một `Pod` mới để thay thế.

```shell
# Lấy danh sách Pods
kubectl get pods
NAME                    READY   STATUS      RESTARTS   AGE
k8s-springboot-series   1/1     Running     0          6s

# Thực hiện xóa Pod `k8s-springboot-series`
kubectl delete pod/k8s-springboot-series
pod "k8s-springboot-series" deleted

# Lấy danh sách Pods
kubectl get pods
NAME       READY   STATUS      RESTARTS   AGE

```

Chúng ta đang mong muốn rằng khi xóa `pod` thì Kubernetes sẽ tạo mới `Pod` mới nhưng phía trên khi xóa `pod` `k8s-springboot-series` thì không thấy có `pod` mới được tạo ra.

### 2.2 Replication Controller trong Kubernetes

**1. Replication Controller là gì?**

`Replication Controller` là một object/resource trong Kubernetes dùng để đảm bảo số lượng `Pod` running trên một thời điểm.

**2. Tại sao lại cần Replication Controller?**

Ở những bài trước thì ứng dụng của chúng ta đang được triển khai trên một `pod` duy nhất, nhưng sẽ có trường hợp `pod` của ứng dụng vì một lý do nào đó mà ứng dụng bị crash và `pod` fails, hoặc `pod` bị xóa. Lúc này khi có request đến ứng dụng thì sẽ bị lỗi. Để ngăn điều trên thì thường ứng dụng sẽ chạy nhiều instance hoặc nhiều `pod` cùng một thời điểm. `Replication Controller` sẽ giúp chúng ta chạy nhiều instance hoặc nhiều `pod` của ứng dụng tại một thời điểm.

**3. Tạo Replication Controller bằng YAML file**

```yaml
apiVersion: v1
kind: ReplicationController
metadata:
  name: k8s-springboot-series # Tên của ReplicationController
spec:
  replicas: 3 # Số lượng Pod muốn chạy trên một thời điểm.
  selector:
    app: k8s-series # Label sử dụng để tim các pods để quản lý.
  template: # Phần này định nghĩa pod template để ReplicationController tạo.
    metadata:
      name: k8s-springboot-series
      labels:
        app: k8s-series
    spec:
      containers:
        - name: k8s-springboot-series
          image: thanhnb1/k8s-springboot-series:latest
          ports:
            - containerPort: 8080
```

`ReplicationController` được chia thành 3 phần:

- `label selector`: Dùng để tìm những pod sẽ được `ReplicationController` quản lý. Ở đây `label selector` là: `app: k8s-series`, nghĩa là `ReplicationController` sẽ tìm những pod có label cùng là `app: k8s-series` để quản lý.
- `replica`: Số lượng pod mà bạn mong muốn ứng dụng sẽ chạy trên một thời điểm. Ở file trên thì `replicas: 3`, nghĩa là `ReplicationController` sẽ phải đảm bảo rằng luôn luôn có 3 pod được chạy trên cùng một thời điểm.
- `pod template`: Template mà `ReplicationController` sẽ dùng để tạo pod.

**4. Triển khai ReplicationController trên Kubernetes**

```shell
# Lấy danh sách pods. Hiện tại không có Pod nào trên namespace default.

kubectl get pods
No resources found in default namespace.
```

Triển khai ReplicationController trên Kubernetes thì sử dụng lệnh `kubectl apply -f <path-replication-controller-file>`.

```shell
kubectl apply -f k8s-springboot-ReplicationController.yaml
replicationcontroller/k8s-springboot-series created

# Lấy danh sách pod. Hiện tại thì đã có 3 pod mới được tạo vì `replicas: 3`.
kubectl get po
NAME                          READY   STATUS    RESTARTS   AGE
k8s-springboot-series-5lwwg   1/1     Running   0          8s
k8s-springboot-series-ff9v2   1/1     Running   0          8s
k8s-springboot-series-qfgh8   1/1     Running   0          8s

# Lấy danh sách `ReplicationController`
kubectl get rc
NAME                    DESIRED   CURRENT   READY   AGE
k8s-springboot-series   3         3         3       101s

# DESIRED=3. Trạng thái mong muốn trên Kubernetes có 3 pod trên cùng một thời điểm (`replicas=3`).
# CURRENT=3. Trạng thái hiện tại trên Kubernetes, đang có 3 pod điều running trên cùng một thời điểm.
# READY=3. Số lượng pod hiện tại running trên Kubernetes.
```

**5. Test ReplicationController trên Kubernetes**

- Xóa Pod xem Replication có tạo mới pod hay không?

  Chúng ta tạo ra `ReplicationController` để giúp quản lý các pod có cùng labels. Phải đảm bảo rằng số lượng Pod chạy trên cùng một thời điểm là giống như định nghĩa. Giả sử khi có một hoặc nhiều pod bị crash hoặc bị xóa thì phải tạo một hoặc nhiều pod mới sao cho đủ số lượng pod chạy trên một thời điểm.

  ```shell
  # Xóa pod k8s-springboot-series-qfgh8 và k8s-springboot-series-ff9v2

  kubectl delete po/k8s-springboot-series-qfgh8 po/k8s-springboot-series-ff9v2
  pod "k8s-springboot-series-qfgh8" deleted
  pod "k8s-springboot-series-ff9v2" deleted

  # Lấy danh sách pod
  kubectl get po
  NAME                          READY   STATUS    RESTARTS   AGE
  k8s-springboot-series-5lwwg   1/1     Running   0          20m
  k8s-springboot-series-hvn2k   1/1     Running   0          38s # Pod này được Replication tạo mới.
  k8s-springboot-series-9f9sl   1/1     Running   0          38s # Pod này được Replication tạo mới.
  ```

- Thay đổi pod template

  Thực hiện thay đổi container image từ `thanhnb1/k8s-springboot-series:latest` sang `thanhnb1/k8s-springboot-series:v2`.

  ```YAML
  apiVersion: v1
  kind: ReplicationController
  metadata:
    name: k8s-springboot-series     # Tên của ReplicationController
  spec:
    replicas: 3                     # Số lượng Pod muốn chạy trên một thời điểm.
    selector:
      app: k8s-series               # Label sử dụng để tim các pods để quản lý.
    template:                       # Phần này định nghĩa pod template để ReplicationController tạo.
      metadata:
        name: k8s-springboot-series
        labels:
          app: k8s-series
      spec:
        containers:
          - name: k8s-springboot-series
            image: thanhnb1/k8s-springboot-series:v2 # thay đổi từ tag `latest` thành `v2`.
            ports:
              - containerPort: 8080
  ```

  Thực hiện triển khai `ReplicationController` mới được thay đổi contaimer image.

  ```shell
  kubectl apply -f k8s-springboot-ReplicationController.yaml
  replicationcontroller/k8s-springboot-series configured

  # Lấy danh sách pod

  kubectl get po
  NAME                          READY   STATUS    RESTARTS   AGE
  k8s-springboot-series-5lwwg   1/1     Running   0          37m
  k8s-springboot-series-hvn2k   1/1     Running   0          17m
  k8s-springboot-series-9f9sl   1/1     Running   0          17m
  ```
